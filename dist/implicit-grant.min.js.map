{"version":3,"file":"implicit-grant.min.js","sources":["../node_modules/@byuweb/browser-oauth/constants.js","../src/url.js","../node_modules/cookie/index.js","../node_modules/local-storage-fallback/lib/CookieStorage.js","../node_modules/local-storage-fallback/lib/isSupported.js","../node_modules/local-storage-fallback/lib/MemoryStorage.js","../node_modules/local-storage-fallback/lib/index.js","../src/local-storage.js","../src/provider.js","../src/implicit-grant.js"],"sourcesContent":["export const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const EVENT_STATE_CHANGE = `${EVENT_PREFIX}-state-changed`;\nexport const EVENT_LOGIN_REQUESTED = `${EVENT_PREFIX}-login-requested`;\nexport const EVENT_LOGOUT_REQUESTED = `${EVENT_PREFIX}-logout-requested`;\nexport const EVENT_REFRESH_REQUESTED = `${EVENT_PREFIX}-refresh-requested`;\nexport const EVENT_CURRENT_INFO_REQUESTED = `${EVENT_PREFIX}-current-info-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\n","/*\n *  @license\n *    Copyright 2018 Brigham Young University\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *        http://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\n\n\"use strict\";\n\nexport function parseHash(hash) {\n  if (!hash) return new Map();\n  let subHash = hash;\n  if (hash.startsWith('#')) {\n    subHash = hash.substr(1);\n  }\n\n  const keyValues = subHash.split('&')\n    .map(it => it.split('=', 2));\n  return new Map(keyValues);\n}\n\n","/*!\n * cookie\n * Copyright(c) 2012-2014 Roman Shtylman\n * Copyright(c) 2015 Douglas Christopher Wilson\n * MIT Licensed\n */\n\n'use strict';\n\n/**\n * Module exports.\n * @public\n */\n\nexports.parse = parse;\nexports.serialize = serialize;\n\n/**\n * Module variables.\n * @private\n */\n\nvar decode = decodeURIComponent;\nvar encode = encodeURIComponent;\nvar pairSplitRegExp = /; */;\n\n/**\n * RegExp to match field-content in RFC 7230 sec 3.2\n *\n * field-content = field-vchar [ 1*( SP / HTAB ) field-vchar ]\n * field-vchar   = VCHAR / obs-text\n * obs-text      = %x80-FF\n */\n\nvar fieldContentRegExp = /^[\\u0009\\u0020-\\u007e\\u0080-\\u00ff]+$/;\n\n/**\n * Parse a cookie header.\n *\n * Parse the given cookie header string into an object\n * The object has the various cookies as keys(names) => values\n *\n * @param {string} str\n * @param {object} [options]\n * @return {object}\n * @public\n */\n\nfunction parse(str, options) {\n  if (typeof str !== 'string') {\n    throw new TypeError('argument str must be a string');\n  }\n\n  var obj = {}\n  var opt = options || {};\n  var pairs = str.split(pairSplitRegExp);\n  var dec = opt.decode || decode;\n\n  for (var i = 0; i < pairs.length; i++) {\n    var pair = pairs[i];\n    var eq_idx = pair.indexOf('=');\n\n    // skip things that don't look like key=value\n    if (eq_idx < 0) {\n      continue;\n    }\n\n    var key = pair.substr(0, eq_idx).trim()\n    var val = pair.substr(++eq_idx, pair.length).trim();\n\n    // quoted values\n    if ('\"' == val[0]) {\n      val = val.slice(1, -1);\n    }\n\n    // only assign once\n    if (undefined == obj[key]) {\n      obj[key] = tryDecode(val, dec);\n    }\n  }\n\n  return obj;\n}\n\n/**\n * Serialize data into a cookie header.\n *\n * Serialize the a name value pair into a cookie string suitable for\n * http headers. An optional options object specified cookie parameters.\n *\n * serialize('foo', 'bar', { httpOnly: true })\n *   => \"foo=bar; httpOnly\"\n *\n * @param {string} name\n * @param {string} val\n * @param {object} [options]\n * @return {string}\n * @public\n */\n\nfunction serialize(name, val, options) {\n  var opt = options || {};\n  var enc = opt.encode || encode;\n\n  if (typeof enc !== 'function') {\n    throw new TypeError('option encode is invalid');\n  }\n\n  if (!fieldContentRegExp.test(name)) {\n    throw new TypeError('argument name is invalid');\n  }\n\n  var value = enc(val);\n\n  if (value && !fieldContentRegExp.test(value)) {\n    throw new TypeError('argument val is invalid');\n  }\n\n  var str = name + '=' + value;\n\n  if (null != opt.maxAge) {\n    var maxAge = opt.maxAge - 0;\n    if (isNaN(maxAge)) throw new Error('maxAge should be a Number');\n    str += '; Max-Age=' + Math.floor(maxAge);\n  }\n\n  if (opt.domain) {\n    if (!fieldContentRegExp.test(opt.domain)) {\n      throw new TypeError('option domain is invalid');\n    }\n\n    str += '; Domain=' + opt.domain;\n  }\n\n  if (opt.path) {\n    if (!fieldContentRegExp.test(opt.path)) {\n      throw new TypeError('option path is invalid');\n    }\n\n    str += '; Path=' + opt.path;\n  }\n\n  if (opt.expires) {\n    if (typeof opt.expires.toUTCString !== 'function') {\n      throw new TypeError('option expires is invalid');\n    }\n\n    str += '; Expires=' + opt.expires.toUTCString();\n  }\n\n  if (opt.httpOnly) {\n    str += '; HttpOnly';\n  }\n\n  if (opt.secure) {\n    str += '; Secure';\n  }\n\n  if (opt.sameSite) {\n    var sameSite = typeof opt.sameSite === 'string'\n      ? opt.sameSite.toLowerCase() : opt.sameSite;\n\n    switch (sameSite) {\n      case true:\n        str += '; SameSite=Strict';\n        break;\n      case 'lax':\n        str += '; SameSite=Lax';\n        break;\n      case 'strict':\n        str += '; SameSite=Strict';\n        break;\n      default:\n        throw new TypeError('option sameSite is invalid');\n    }\n  }\n\n  return str;\n}\n\n/**\n * Try decoding a string using a decoding function.\n *\n * @param {string} str\n * @param {function} decode\n * @private\n */\n\nfunction tryDecode(str, decode) {\n  try {\n    return decode(str);\n  } catch (e) {\n    return str;\n  }\n}\n","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nexports.hasCookies = hasCookies;\n\nvar _cookie = require('cookie');\n\nvar _cookie2 = _interopRequireDefault(_cookie);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar prefix = 'lS_';\n\nvar CookieStorage = function () {\n  function CookieStorage() {\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, CookieStorage);\n\n    this.cookieOptions = Object.assign({ path: '/' }, options);\n    prefix = options.prefix || prefix;\n  }\n\n  _createClass(CookieStorage, [{\n    key: 'getItem',\n    value: function getItem(key) {\n      var cookies = _cookie2.default.parse(document.cookie);\n      if (!cookies || !cookies.hasOwnProperty(prefix + key)) {\n        return null;\n      }\n      return cookies[prefix + key];\n    }\n  }, {\n    key: 'setItem',\n    value: function setItem(key, value) {\n      document.cookie = _cookie2.default.serialize(prefix + key, value, this.cookieOptions);\n      return value;\n    }\n  }, {\n    key: 'removeItem',\n    value: function removeItem(key) {\n      var options = Object.assign({}, this.cookieOptions, { maxAge: -1 });\n      document.cookie = _cookie2.default.serialize(prefix + key, '', options);\n      return null;\n    }\n  }, {\n    key: 'clear',\n    value: function clear() {\n      var cookies = _cookie2.default.parse(document.cookie);\n      for (var key in cookies) {\n        if (key.indexOf(prefix) === 0) {\n          this.removeItem(key.substr(prefix.length));\n        }\n      }\n\n      return null;\n    }\n  }]);\n\n  return CookieStorage;\n}();\n\nexports.default = CookieStorage;\nfunction hasCookies() {\n  var storage = new CookieStorage();\n\n  try {\n    var TEST_KEY = '__test';\n    storage.setItem(TEST_KEY, '1');\n    var value = storage.getItem(TEST_KEY);\n    storage.removeItem(TEST_KEY);\n\n    return value === '1';\n  } catch (e) {\n    return false;\n  }\n}","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = isSupported;\n\nvar _CookieStorage = require('./CookieStorage');\n\nvar TEST_KEY = '__test';\n\nfunction hasStorage(name) {\n  try {\n    var storage = window[name];\n    storage.setItem(TEST_KEY, '1');\n    storage.removeItem(TEST_KEY);\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction isSupported() {\n  var name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'localStorage';\n\n  var storage = String(name).replace(/storage$/i, '').toLowerCase();\n\n  if (storage === 'local') {\n    return hasStorage('localStorage');\n  }\n\n  if (storage === 'session') {\n    return hasStorage('sessionStorage');\n  }\n\n  if (storage === 'cookie') {\n    return (0, _CookieStorage.hasCookies)();\n  }\n\n  if (storage === 'memory') {\n    return true;\n  }\n\n  throw new Error('Storage method `' + name + '` is not available.\\n    Please use one of the following: localStorage, sessionStorage, cookieStorage, memoryStorage.');\n}","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar MemoryStorage = function () {\n  function MemoryStorage() {\n    _classCallCheck(this, MemoryStorage);\n\n    this._data = {};\n  }\n\n  _createClass(MemoryStorage, [{\n    key: \"getItem\",\n    value: function getItem(key) {\n      return this._data.hasOwnProperty(key) ? this._data[key] : null;\n    }\n  }, {\n    key: \"setItem\",\n    value: function setItem(key, value) {\n      return this._data[key] = String(value);\n    }\n  }, {\n    key: \"removeItem\",\n    value: function removeItem(key) {\n      return delete this._data[key];\n    }\n  }, {\n    key: \"clear\",\n    value: function clear() {\n      return this._data = {};\n    }\n  }]);\n\n  return MemoryStorage;\n}();\n\nexports.default = MemoryStorage;","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.MemoryStorage = exports.CookieStorage = exports.isSupported = exports.storage = undefined;\n\nvar _isSupported = require('./isSupported');\n\nvar _isSupported2 = _interopRequireDefault(_isSupported);\n\nvar _CookieStorage = require('./CookieStorage');\n\nvar _CookieStorage2 = _interopRequireDefault(_CookieStorage);\n\nvar _MemoryStorage = require('./MemoryStorage');\n\nvar _MemoryStorage2 = _interopRequireDefault(_MemoryStorage);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar storage = null;\n\nif ((0, _isSupported2.default)('localStorage')) {\n  // use localStorage\n  exports.storage = storage = window.localStorage;\n} else if ((0, _isSupported2.default)('sessionStorage')) {\n  // use sessionStorage\n  exports.storage = storage = window.sessionStorage;\n} else if ((0, _isSupported2.default)('cookieStorage')) {\n  // use cookies\n  exports.storage = storage = new _CookieStorage2.default();\n} else {\n  // use memory\n  exports.storage = storage = new _MemoryStorage2.default();\n}\n\nexports.default = storage;\nexports.storage = storage;\nexports.isSupported = _isSupported2.default;\nexports.CookieStorage = _CookieStorage2.default;\nexports.MemoryStorage = _MemoryStorage2.default;","/*\n *  @license\n *    Copyright 2018 Brigham Young University\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *        http://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\n\n\"use strict\";\n\nimport storage from 'local-storage-fallback';\n\nexport class StorageHandler {\n\n  saveOAuthState(clientId, state) {\n    storage.setItem(getKey(clientId), JSON.stringify(state));\n  }\n\n  getOAuthState(clientId) {\n    const result = storage.getItem(getKey(clientId));\n    if (!result) {\n      return null;\n    }\n    return JSON.parse(result);\n  }\n\n  clearOAuthState(clientId) {\n    storage.removeItem(getKey(clientId));\n  }\n}\n\nfunction getKey(clientId) {\n  return 'oauth-state-' + encodeURIComponent(clientId);\n}\n\n","/*\n *  @license\n *    Copyright 2018 Brigham Young University\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *        http://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\n\"use strict\";\n\nimport * as authn from '../node_modules/@byuweb/browser-oauth/constants.js';\nimport {parseHash} from './url.js';\nimport {StorageHandler} from \"./local-storage\";\n\nconst STORED_STATE_LIFETIME = 5 * 60 * 1000; // 5 minutes\n\nexport class ImplicitGrantProvider {\n  constructor(config, window, document, storageHandler = new StorageHandler()) {\n    this.config = config;\n    this.window = window;\n    this.document = document;\n    this.storageHandler = storageHandler;\n    this._listeners = {};\n\n    this.store = Object.freeze({\n      state: authn.STATE_INDETERMINATE,\n      user: null,\n      token: null,\n      error: null\n    })\n  }\n\n  _changeState(state, user, token, error) {\n    this.store = Object.freeze({\n      state, user, token, error\n    });\n    _dispatchEvent(this, authn.EVENT_STATE_CHANGE, this.store)\n  }\n\n  async startup() {\n    this.listen();\n    this._changeState(authn.STATE_INDETERMINATE);\n\n    const location = this._location;\n    const hash = this._hashParams;\n\n    if (this.isAuthenticationCallback(location.href, hash)) {\n      this._changeState(authn.STATE_AUTHENTICATING);\n      try {\n        const {state, user, token, error} = await _handleAuthenticationCallback(\n          this.config,\n          location,\n          hash,\n          this.storageHandler\n        );\n        this._changeState(state, user, token, error);\n      } catch (err) {\n        console.error('OAuth Error', err);\n        this._changeState(authn.STATE_ERROR, undefined, undefined, err);\n      }\n    } else {\n      this._changeState(authn.STATE_UNAUTHENTICATED);\n    }\n  }\n\n  get _location() {\n    return this.window.location;\n  }\n\n  get _hashParams() {\n    return parseHash(this._location.hash);\n  }\n\n  isAuthenticationCallback(href, hash) {\n    const isCallbackUrl = href.indexOf(this.config.callbackUrl) === 0;\n    const hasHash = hash.size !== 0;\n\n    if (!isCallbackUrl || !hasHash) {\n      return false;\n    }\n\n    return hash.has('access_token') || hash.has('error');\n  }\n\n  shutdown() {\n    this.unlisten();\n    this._changeState(authn.STATE_INDETERMINATE);\n  }\n\n  listen() {\n    _listenTo(this, authn.EVENT_LOGIN_REQUESTED, this.startLogin);\n    _listenTo(this, authn.EVENT_LOGOUT_REQUESTED, this.startLogout);\n    _listenTo(this, authn.EVENT_REFRESH_REQUESTED, this.startRefresh);\n    _listenTo(this, authn.EVENT_CURRENT_INFO_REQUESTED, this.handleCurrentInfoRequest);\n  }\n\n  unlisten() {\n    _unlistenTo(this, authn.EVENT_LOGIN_REQUESTED);\n    _unlistenTo(this, authn.EVENT_LOGOUT_REQUESTED);\n    _unlistenTo(this, authn.EVENT_REFRESH_REQUESTED);\n    _unlistenTo(this, authn.EVENT_CURRENT_INFO_REQUESTED);\n  }\n\n  startLogin() {\n    console.log('starting login', this);\n    const {clientId, callbackUrl} = this.config;\n    const csrf = randomString();\n\n    const storedState = _prepareStoredState(Date.now() + STORED_STATE_LIFETIME, csrf, {});\n    this.storageHandler.saveOAuthState(this.config.clientId, storedState);\n\n    const loginUrl = `https://api.byu.edu/authorize?response_type=token&client_id=${clientId}&redirect_uri=${encodeURIComponent(callbackUrl)}&scope=openid&state=${csrf}`;\n\n    console.warn(`[OAuth] - Redirecting user to '${loginUrl}'`);\n\n    this.window.location = loginUrl;\n  }\n\n  startLogout() {\n    const redirectUrl = this.config.callbackUrl;\n    this.window.location = 'http://api.byu.edu/logout?redirect_url=' + redirectUrl;\n    //https://api.byu.edu/revoke\n\n    //TODO: WSO2 Identity Server 5.1 allows us to revoke implicit tokens.  Once that's done, we'll need to do this.\n    // const url = `https://api.byu.edu/revoke`;\n\n    // const form = new URLSearchParams();\n    // form.set('token', store.token.bearer);\n    // form.set('client_id', config.clientId);\n    // form.set('token_type_hint', 'access_token');\n\n    // console.log('logout url', url);\n\n    // fetch(url, {\n    //     method: 'POST',\n    //     body: form,\n    //     // headers: {\n    //     //     'Content-Type': 'application/x-www-form-urlencoded'\n    //     // }\n    // }).then(result => {\n    //     console.log('done with logout', result);\n    // });\n  }\n\n  startRefresh() {\n    this.startLogin();\n  }\n\n  handleCurrentInfoRequest() {\n\n  }\n}\n\nfunction _listenTo(provider, event, listener) {\n  if (provider._listeners.hasOwnProperty(event)) {\n    throw new Error('A listener is already registered for ' + event);\n  }\n  const obs = provider._listeners[event] = function (e) {\n    listener.call(provider, e.detail);\n  }.bind(provider);\n\n  provider.document.addEventListener(event, obs, false);\n}\n\nfunction _unlistenTo(provider, event) {\n  if (!provider._listeners.hasOwnProperty(event)) {\n    return;\n  }\n\n  provider.document.removeEventListener(event, provider._listeners[event], false);\n  delete provider._listeners[event];\n}\n\n\nfunction _dispatchEvent(provider, name, detail) {\n  let event;\n  if (typeof provider.window.CustomEvent === 'function') {\n    event = new CustomEvent(name, {detail});\n  } else {\n    event = provider.document.createEvent('CustomEvent');\n    event.initCustomEvent(name, true, false, detail);\n  }\n  provider.document.dispatchEvent(event);\n}\n\nasync function _handleAuthenticationCallback(config, location, hash, storage) {\n  if (hash.has('error')) {\n    throw new OAuthError(\n      hash.get('error'),\n      hash.get('error_description'),\n      hash.get('error_uri'),\n    );\n  }\n  const oauthCsrfToken = hash.get('state');\n  const storedState = storage.getOAuthState(config.clientId);\n\n  storage.clearOAuthState(config.clientId);\n\n  const pageState = _validateAndGetStoredState(storedState, oauthCsrfToken);\n\n  const accessToken = hash.get('access_token');\n  const expiresIn = Number(hash.get('expires_in'));\n  const expiresAt = new Date(Date.now() + (expiresIn * 1000));\n  const authHeader = `Bearer ${accessToken}`;\n\n  const userInfo = await _fetchUserInfo(authHeader);\n\n  const user = _processUserInfo(userInfo);\n  const token = _processTokenInfo(userInfo, accessToken, expiresAt, authHeader);\n\n  location.hash = '';\n\n  return {state: authn.STATE_AUTHENTICATED, user, token};\n}\n\nasync function _fetchUserInfo(authHeader) {\n  const resp = await fetch('https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid', {\n    method: 'GET',\n    headers: new Headers({'Accept': 'application/json', 'Authorization': authHeader}),\n    mode: 'cors',\n  });\n\n  if (resp.status !== 200) {\n    const body = await resp.text();\n\n    if (resp.status === 403) {\n      if (body.includes('<ams:code>900908</ams:code>')) {\n        console.error(`DEVELOPER ERROR: You may not be subscribed to the OpenID UserInfo endpoint. Please visit https://api.byu.edu/store/apis/info?name=OpenID-Userinfo&version=v1&provider=BYU%2Fjmooreoa to subscribe.`);\n        throw new OAuthError(\n          'not-subscribe-to-user-info',\n          'This page has an authentication configuration error. Developers, see the console for details.'\n        );\n      } else {\n        throw new OAuthError(\n          'invalid-oauth-token',\n          'The provided authentication token is invalid. Please try again.'\n        );\n      }\n    }\n    console.error('Error getting OAuth User Info. Status Code:', resp.status, 'Response:\\n', body);\n    throw new OAuthError(\n      'unable-to-get-user-info',\n      'Unable to fetch user information. Please try again.'\n    );\n  }\n\n  return await resp.json();\n}\n\n\nconst CLAIMS_PREFIX_RESOURCE_OWNER = 'http://byu.edu/claims/resourceowner_';\nconst CLAIMS_PREFIX_CLIENT = 'http://byu.edu/claims/client_';\nconst CLAIMS_PREFIX_WSO2 = 'http://wso2.org/claims/';\n\nfunction getClaims(userInfo, prefix) {\n  return Object.keys(userInfo).filter(k => k.startsWith(prefix))\n    .reduce((agg, key) => {\n      agg[key.substr(prefix.length)] = userInfo[key];\n      return agg;\n    }, {});\n}\n\nfunction _processUserInfo(userInfo) {\n  const roClaims = getClaims(userInfo, CLAIMS_PREFIX_RESOURCE_OWNER);\n\n  const familyNamePosition = roClaims.surname_position;\n  const givenName = userInfo.given_name;\n  const familyName = userInfo.family_name;\n\n  const displayName = familyNamePosition === 'F' ? `${familyName} ${givenName}` : `${givenName} ${familyName}`;\n\n  return {\n    personId: roClaims.person_id,\n    byuId: roClaims.byu_id,\n    netId: roClaims.net_id,\n    name: {\n      sortName: roClaims.sort_name,\n      displayName,\n      givenName,\n      familyName,\n      familyNamePosition,\n    },\n    rawUserInfo: userInfo\n  };\n}\n\nfunction _processTokenInfo(userInfo, accessToken, expiresAt, authHeader) {\n  const clientClaims = getClaims(userInfo, CLAIMS_PREFIX_CLIENT);\n  const wso2Claims = getClaims(userInfo, CLAIMS_PREFIX_WSO2);\n\n  return {\n    bearer: accessToken,\n    authorizationHeader: authHeader,\n    expiresAt,\n    client: {\n      id: wso2Claims.client_id,\n      byuId: clientClaims.byu_id,\n      appName: wso2Claims.applicationname,\n    },\n    rawUserInfo: userInfo\n  };\n}\n\nfunction _validateAndGetStoredState(storedState, expectedCsrfToken) {\n  const {e: stateExpiresString, c: storedCsrfToken, s: pageState} = storedState;\n\n  if (expectedCsrfToken !== storedCsrfToken) {\n    throw new OAuthError(\n      'oauth-state-mismatch',\n      'Your saved authentication information does not match. Please try again.'\n    );\n  }\n\n  if (Number(stateExpiresString) < Date.now()) {\n    throw new OAuthError(\n      'oauth-state-expired',\n      'Your login attempt has timed out. Please try again.'\n    );\n  }\n\n  return pageState;\n}\n\nfunction _prepareStoredState(expires, csrfToken, pageState) {\n  return {\n    e: expires,\n    c: csrfToken,\n    s: pageState,\n  }\n}\n\nclass OAuthError extends Error {\n  constructor(type, description, uri) {\n    super('OAuth Error: ' + description);\n    this.type = type;\n    this.description = description;\n    this.uri = uri;\n  }\n}\n\nfunction randomString() {\n  let idArray = new Uint32Array(3);\n  const crypto = window.crypto || window.msCrypto;\n  crypto.getRandomValues(idArray);\n\n  return idArray.reduce((str, cur) => str + cur.toString(16), '');\n}\n\n\n","/*\n * Copyright 2018 Brigham Young University\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *    http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as authn from '../node_modules/@byuweb/browser-oauth/constants.js';\nimport { ImplicitGrantProvider } from \"./provider.js\";\n\nexport const DEFAULT_ISSUER = 'https://api.byu.edu';\n\nexport const GLOBAL_CONFIG_KEY = 'byu-oauth-implicit-config';\n\nlet store = Object.freeze({state: authn.STATE_INDETERMINATE});\n\n/*\n * TODOS:\n *  - implement logout\n *  - implement requireAuthentication\n */\n\n/**\n * @typedef {} ImplicitConfig\n * @prop {string} clientId\n * @prop {?string} issuer\n * @prop {?string} callbackUrl\n * @prop {?boolean} requireAuthentication\n */\n\n/**\n *\n * @param {ImplicitConfig} cfg\n */\nexport async function configure(cfg) {\n  const globalConfig = window[GLOBAL_CONFIG_KEY];\n\n  console.log('base', document.baseURI);\n\n  const config = Object.assign({\n    issuer: DEFAULT_ISSUER,\n    callbackUrl: `${location.origin}${location.pathname}`,\n    requireAuthentication: false,\n  }, globalConfig, cfg);\n\n  if (!config.clientId) {\n    throw new Error('clientId must be specified in config');\n  }\n\n  const provider = new ImplicitGrantProvider(config, window, document);\n\n  return provider.startup();\n\n  // await maybeHandleAuthenticationCallback(config);\n  // await maybeForceLogin(config);\n}\n\n\n\nexport function startLogin() {\n  const config = getConfig();\n  const csrf = saveLoginToken(randomString(), {});\n\n  const loginUrl = `https://api.byu.edu/authorize?response_type=token&client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.callbackUrl)}&scope=openid&state=${csrf}`;\n\n  window.location = loginUrl;\n}\n\n\nexport function startRefresh() {\n  startLogin();\n}\n\nexport function handleCurrentInfoRequest({callback}) {\n  callback(store);\n}\n\nexport function startLogout() {\n  const config = getConfig();\n  window.location = 'http://api.byu.edu/logout?redirect_url=' + config.callbackUrl;\n  //https://api.byu.edu/revoke\n\n  //TODO: WSO2 Identity Server 5.1 allows us to revoke implicit tokens.  Once that's done, we'll need to do this.\n  // const url = `https://api.byu.edu/revoke`;\n\n  // const form = new URLSearchParams();\n  // form.set('token', store.token.bearer);\n  // form.set('client_id', config.clientId);\n  // form.set('token_type_hint', 'access_token');\n\n  // console.log('logout url', url);\n\n  // fetch(url, {\n  //     method: 'POST',\n  //     body: form,\n  //     // headers: {\n  //     //     'Content-Type': 'application/x-www-form-urlencoded'\n  //     // }\n  // }).then(result => {\n  //     console.log('done with logout', result);\n  // });\n}\n\n\nasync function maybeHandleAuthenticationCallback() {\n  if (!isAuthenticationCallback()) {\n    state(authn.STATE_UNAUTHENTICATED);\n    return;\n  }\n  state(authn.STATE_AUTHENTICATING);\n  const params = new URLSearchParams(window.location.hash.substring(1));\n  if (params.has('error')) {\n    const error = {\n      type: params.get('error'),\n      description: params.get('error_description'),\n      uri: params.get('error_uri')\n    };\n    state(\n      authn.STATE_ERROR,\n      null,\n      null,\n      error\n    );\n    return;\n  }\n\n  const csrf = params.get('state');\n\n  window.location.hash = '';\n\n  let pageData;\n  try {\n    pageData = validateCsrfAndGetPageData(csrf);\n  } catch (err) {\n    state(authn.STATE_ERROR, null, null, {\n      type: 'oauth-state-mismatch',\n      description: err.message || err,\n    });\n    return;\n  }\n\n  clearSavedStateFor('s');\n\n  const accessToken = params.get('access_token');\n  const expiresIn = Number(params.get('expires_in'));\n  const authHeader = `Bearer ${accessToken}`;\n  const expiresAt = new Date(Date.now() + (expiresIn * 1000));\n\n  const result = await fetch('https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid', {\n    method: 'GET',\n    headers: new Headers({'Accept': 'application/json', 'authorization': authHeader}),\n    mode: 'cors',\n  }).then(function (resp) {\n    return resp.json();\n  }).then(function (json) {\n    const roClaims = getClaims(json, CLAIMS_PREFIX_RESOURCE_OWNER);\n    const clientClaims = getClaims(json, CLAIMS_PREFIX_CLIENT);\n    const wso2Claims = getClaims(json, CLAIMS_PREFIX_WSO2);\n\n    const familyNamePosition = roClaims.surname_position;\n    const givenName = json.given_name;\n    const familyName = json.family_name;\n\n    const displayName = familyNamePosition === 'F' ? `${familyName} ${givenName}` : `${givenName} ${familyName}`;\n\n    const user = {\n      personId: roClaims.person_id,\n      byuId: roClaims.byu_id,\n      netId: roClaims.net_id,\n      name: {\n        sortName: roClaims.sort_name,\n        displayName,\n        givenName,\n        familyName,\n        familyNamePosition,\n      },\n      rawUserInfo: json\n    };\n\n    const token = {\n      bearer: accessToken,\n      authorizationHeader: authHeader,\n      expiresAt,\n      client: {\n        id: wso2Claims.client_id,\n        byuId: clientClaims.byu_id,\n        appName: wso2Claims.applicationname,\n      },\n      rawUserInfo: json\n    };\n\n    state(authn.STATE_AUTHENTICATED, token, user);\n  });\n}\n\nfunction maybeForceLogin() {\n\n}\n\nconst CLAIMS_PREFIX_RESOURCE_OWNER = 'http://byu.edu/claims/resourceowner_';\nconst CLAIMS_PREFIX_CLIENT = 'http://byu.edu/claims/client_';\nconst CLAIMS_PREFIX_WSO2 = 'http://wso2.org/claims/';\n\nfunction getClaims(userInfo, prefix) {\n  return Object.keys(userInfo).filter(k => k.startsWith(prefix))\n    .reduce((agg, key) => {\n      agg[key.substr(prefix.length)] = userInfo[key];\n      return agg;\n    }, {});\n}\n\nfunction isAuthenticationCallback() {\n  const config = getConfig();\n  const isCallbackUrl = window.location.href.indexOf(config.callbackUrl) === 0;\n  const hasHash = !!window.location.hash;\n\n  if (!isCallbackUrl) {\n    return false;\n  } else if (!hasHash) {\n    return false;\n  }\n  const params = new URLSearchParams(window.location.hash.substring(1));\n  if (params.has('access_token') || params.has('error')) {\n    return true;\n  }\n  return false;\n}\n\nfunction state(state, token, user, error) {\n  store = Object.freeze({state, token, user, error});\n  dispatch(authn.EVENT_STATE_CHANGE, store);\n}\n\nfunction saveLoginToken(token, pageState) {\n  const config = getConfig();\n  const name = getStorgeName(config.clientId);\n  const value = `${token}.${btoa(JSON.stringify(pageState))}`;\n\n  let type;\n  if (storageAvailable('sessionStorage')) {\n    window.sessionStorage.setItem(name, value);\n    type = TOKEN_STORE_TYPE_SESSION;\n  } else {\n    document.cookie = `${name}=${value};max-age=300`;\n    type = TOKEN_STORE_TYPE_COOKIE;\n  }\n  return type + '.' + token;\n}\n\nfunction getStorageName(clientId) {\n  return `oauth-state-${encodeURIComponent(clientId)}`;\n}\n\nconst TOKEN_STORE_TYPE_SESSION = 's';\nconst TOKEN_STORE_TYPE_COOKIE = 'c';\n\nfunction validateCsrfAndGetPageData(csrf) {\n  const [type, token] = csrf.split('.');\n  const possibleValues = getSavedStateFor(type);\n\n  if (possibleValues.length === 0) {\n    console.error('No OAuth state has been stored, or it has expired');\n    throw new Error('Your authentication session has expired or something has gone wrong.');\n  }\n  const found = possibleValues.map(v => v.split('.'))\n    .find(([key, data]) => key === token);\n\n  if (!found) {\n    console.error('Authentication state mismatch - no saved values match CSRF token');\n    throw new Error('Your saved authentication information does not match. Please try again.');\n  }\n\n  const pageData = found[1];\n\n  return JSON.parse(atob(pageData));\n}\n\nfunction getSavedStateFor(type) {\n  const config = getConfig();\n  const name = getStorageName(config.clientId);\n  switch (type) {\n    case TOKEN_STORE_TYPE_SESSION:\n      return [window.sessionStorage.getItem(name)];\n    case TOKEN_STORE_TYPE_COOKIE:\n      const values = [];\n      (document.cookie || '').split(';').map(c => c.trim()).forEach(cookie => {\n        if (cookie.indexOf(name + '=') === 0) {\n          values.push(cookie.split('=', 2)[1]);\n        }\n      });\n      return values;\n  }\n}\n\nfunction clearSavedStateFor(type) {\n  const config = getConfig();\n  const name = getStorageName(config.clientId);\n  switch (type) {\n    case TOKEN_STORE_TYPE_SESSION:\n      window.sessionStorage.removeItem(name);\n      break;\n    case TOKEN_STORE_TYPE_COOKIE:\n      document.cookie = name + '=null;expires=Thu, 01 Jan 1970 00:00:00 GMT';\n      break;\n  }\n}\n\n\nfunction storageAvailable(type) {\n  let storage = '';\n  try {\n    storage = window[type];\n    const testString = '__storage_test__';\n    storage.setItem(testString, testString);\n    storage.removeItem(testString);\n    return true;\n  }\n  catch (e) {\n    return e instanceof DOMException && (\n        // everything except Firefox\n      e.code === 22 ||\n      // Firefox\n      e.code === 1014 ||\n      // test name field too, because code might not be present\n      // everything except Firefox\n      e.name === 'QuotaExceededError' ||\n      // Firefox\n      e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&\n      // acknowledge QuotaExceededError only if there's something already stored\n      storage.length !== 0;\n  }\n}\n\nfunction randomString() {\n  let idArray = new Uint32Array(3);\n  const crypto = window.crypto || window.msCrypto;\n  crypto.getRandomValues(idArray);\n\n  return idArray.reduce((str, cur) => str + cur.toString(16), '');\n}\n\nfunction dispatch(name, detail) {\n  let event;\n  if (typeof window.CustomEvent === 'function') {\n    event = new CustomEvent(name, {detail});\n  } else {\n    event = document.createEvent('CustomEvent');\n    event.initCustomEvent(name, true, false, detail);\n  }\n  document.dispatchEvent(event);\n}\n"],"names":["EVENT_PREFIX","EVENT_STATE_CHANGE","EVENT_LOGIN_REQUESTED","EVENT_LOGOUT_REQUESTED","EVENT_REFRESH_REQUESTED","EVENT_CURRENT_INFO_REQUESTED","STATE_INDETERMINATE","STATE_UNAUTHENTICATED","STATE_AUTHENTICATED","STATE_AUTHENTICATING","STATE_ERROR","parseHash","Map","subHash","hash","startsWith","substr","keyValues","split","map","it","exports","parse","serialize","decode","decodeURIComponent","encode","encodeURIComponent","pairSplitRegExp","fieldContentRegExp","TypeError","obj","opt","options","pairs","str","dec","i","length","pair","eq_idx","indexOf","key","trim","val","slice","undefined","tryDecode","enc","test","value","name","maxAge","isNaN","Error","Math","floor","domain","path","expires","toUTCString","httpOnly","secure","sameSite","toLowerCase","instance","Object","defineProperty","_createClass","props","descriptor","enumerable","configurable","writable","defineProperties","Constructor","prototype","storage","TEST_KEY","setItem","getItem","removeItem","_cookie2","__esModule","default","_interopRequireDefault","_cookie","prefix","CookieStorage","arguments","cookieOptions","assign","cookies","document","cookie","hasOwnProperty","window","String","replace","hasStorage","_CookieStorage","hasCookies","MemoryStorage","_data","_isSupported2","_isSupported","_CookieStorage2","_MemoryStorage2","_MemoryStorage","localStorage","sessionStorage","StorageHandler","getKey","JSON","stringify","result","STORED_STATE_LIFETIME","ImplicitGrantProvider","storageHandler","config","_listeners","store","freeze","authn","user","token","error","startup","listen","_changeState","location","_location","_hashParams","isAuthenticationCallback","href","state","_handleAuthenticationCallback","isCallbackUrl","callbackUrl","hasHash","size","has","unlisten","startLogin","startLogout","startRefresh","handleCurrentInfoRequest","log","clientId","csrf","randomString","storedState","_prepareStoredState","Date","now","saveOAuthState","loginUrl","warn","redirectUrl","_listenTo","provider","obs","call","e","detail","bind","addEventListener","_unlistenTo","removeEventListener","_dispatchEvent","event","CustomEvent","createEvent","initCustomEvent","dispatchEvent","OAuthError","get","oauthCsrfToken","getOAuthState","clearOAuthState","pageState","_validateAndGetStoredState","accessToken","expiresIn","expiresAt","authHeader","userInfo","_fetchUserInfo","_processUserInfo","_processTokenInfo","resp","fetch","Headers","status","body","text","includes","json","CLAIMS_PREFIX_RESOURCE_OWNER","CLAIMS_PREFIX_CLIENT","CLAIMS_PREFIX_WSO2","getClaims","keys","filter","k","reduce","roClaims","familyNamePosition","surname_position","givenName","given_name","familyName","family_name","displayName","person_id","byu_id","net_id","sort_name","clientClaims","wso2Claims","client_id","applicationname","c","s","expectedCsrfToken","Number","type","description","uri","idArray","Uint32Array","crypto","msCrypto","getRandomValues","cur","toString","DEFAULT_ISSUER","GLOBAL_CONFIG_KEY","configure","globalConfig","baseURI","origin","pathname","getConfig","saveLoginToken","callback","getStorgeName","btoa","storageAvailable","TOKEN_STORE_TYPE_SESSION","TOKEN_STORE_TYPE_COOKIE","testString","DOMException","code"],"mappings":"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"}