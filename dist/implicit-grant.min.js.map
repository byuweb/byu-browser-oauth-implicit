{"version":3,"file":"implicit-grant.min.js","sources":["../node_modules/@byuweb/browser-oauth/byu-browser-oauth.js","../src/implicit-grant.js"],"sourcesContent":["/*\n * Copyright 2018 Brigham Young University\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const STATE_CHANGE_EVENT = `${EVENT_PREFIX}-state-changed`;\nexport const LOGIN_REQUESTED_EVENT = `${EVENT_PREFIX}-login-requested`;\nexport const LOGOUT_REQUESTED_EVENT = `${EVENT_PREFIX}-logout-requested`;\nexport const REFRESH_REQUESTED_EVENT = `${EVENT_PREFIX}-refresh-requested`;\nexport const STATE_REQUESTED_EVENT = `${EVENT_PREFIX}-state-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\nlet store = {state: STATE_INDETERMINATE};\n\nlet observer = onStateChange(detail => {\n    store = detail;\n});\n\nexport function onStateChange(callback) {\n    const func = function(e) {\n        callback(e.detail);\n    };\n    document.addEventListener(STATE_CHANGE_EVENT, func, false);\n    if (store.state === STATE_INDETERMINATE) {\n        dispatch(STATE_REQUESTED_EVENT, {callback});\n    } else {\n        callback(store);\n    }\n    return {\n        offStateChange: function() {\n            document.removeEventListener(STATE_CHANGE_EVENT, func, false);\n        }\n    }\n}\n\nexport function state() {\n    return store.state;\n}\n\nexport function hasToken() {\n    return !!store.token;\n}\n\nexport function token() {\n    return store.token;\n}\n\nexport function authorizationHeader() {\n    return store.token && store.token.authorizationHeader;\n}\n\nexport function user() {\n    return store.user;\n}\n\nexport function login() {\n    const promise = promiseState([STATE_AUTHENTICATED])\n    dispatch(LOGIN_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function logout() {\n    const promise = promiseState([STATE_UNAUTHENTICATED]);\n    dispatch(LOGOUT_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function refresh() {\n    const promise = promiseState([STATE_AUTHENTICATED, STATE_UNAUTHENTICATED]);\n    dispatch(REFRESH_REQUESTED_EVENT);\n    return promise;\n}\n\nexport function teardown() {\n    observer.offStateChange();\n    store = {state: STATE_INDETERMINATE};\n}\n\nfunction promiseState(desiredStates) {\n    if (!window.Promise) {\n        return null;\n    }\n    return new Promise((resolve, reject) => {\n        const observer = onStateChange(({state, token, user, error}) => {\n            if (error) {\n                reject(error);\n                observer.offStateChange();\n            } else if (desiredStates.indexOf(state) >= 0) {\n                resolve({state, token, user});\n                observer.offStateChange();\n            }\n        });\n    });\n}\n\nfunction dispatch(name, detail) {\n    let event;\n    if (typeof window.CustomEvent === 'function') {\n        event = new CustomEvent(name, {detail});\n    } else {\n        event = document.createEvent('CustomEvent');\n        event.initCustomEvent(name, true, false, detail);\n    }\n    document.dispatchEvent(event);\n}\n\n","/*\n * Copyright 2018 Brigham Young University\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *    http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as authn from '../node_modules/@byuweb/browser-oauth/byu-browser-oauth.js';\n\nexport const DEFAULT_ISSUER = 'https://api.byu.edu';\n\nlet config;\nconst observers = {};\nlet store = Object.freeze({ state: authn.STATE_INDETERMINATE });\n\n/**\n * @typedef {} ImplicitConfig\n * @prop {string} clientId\n * @prop {?string} issuer\n * @prop {?string} callbackUrl\n * @prop {?boolean} requireAuthentication\n */\n\n/**\n * \n * @param {ImplicitConfig} cfg \n */\nexport function configure(cfg) {\n    console.log('config', cfg);\n    if (!cfg) {\n        throw new Error('cfg must be defined');\n    }\n    if (!cfg.clientId) {\n        throw new Error('clientId must be specified');\n    }\n    config = Object.assign({\n        issuer: DEFAULT_ISSUER,\n        callbackUrl: `${location.origin}${location.pathname}`,\n        requireAuthentication: false,\n    }, cfg);\n\n    listen(authn.LOGIN_REQUESTED_EVENT, startLogin);\n    listen(authn.LOGOUT_REQUESTED_EVENT, startLogout);\n    listen(authn.REFRESH_REQUESTED_EVENT, startRefresh);\n    listen(authn.STATE_REQUESTED_EVENT, handleStateRequested);\n\n    maybeHandleAuthenticationCallback();\n}\n\nfunction maybeHandleAuthenticationCallback() {\n    if (!isAuthenticationCallback()) {\n        console.log('Not an auth callback');\n        state(authn.STATE_UNAUTHENTICATED);\n        return;\n    }\n    state(authn.STATE_AUTHENTICATING);\n    const params = new URLSearchParams(window.location.hash.substring(1));\n    if (params.has('error')) {\n        const error = {\n            type: params.get('error'),\n            description: params.get('error_description'),\n            uri: params.get('error_uri')\n        };\n        state(\n            authn.STATE_ERROR,\n            null,\n            null,\n            error\n        );\n        return;\n    }\n\n    const csrf = params.get('state');\n\n    window.location.hash = '';\n\n    const accessToken = params.get('access_token');\n    const expiresIn = Number(params.get('expires_in'));\n    const authHeader = `Bearer ${accessToken}`;\n    const expiresAt = new Date(Date.now() + (expiresIn * 1000));\n\n    fetch('https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid', {\n        method: 'GET',\n        headers: new Headers({ 'Accept': 'application/json', 'authorization': authHeader }),\n        mode: 'cors',\n    }).then(function (resp) {\n        return resp.json();\n    }).then(function (json) {\n        console.log('got user info', json);\n\n        const roClaims = getClaims(json, CLAIMS_PREFIX_RESOURCE_OWNER);\n        const clientClaims = getClaims(json, CLAIMS_PREFIX_CLIENT);\n        const wso2Claims = getClaims(json, CLAIMS_PREFIX_WSO2);\n\n        console.log('claims', roClaims, clientClaims, wso2Claims);\n        \n        const familyNamePosition = roClaims.surname_position;\n        const givenName = json.given_name;\n        const familyName = json.family_name;\n\n        const displayName = familyNamePosition === 'F' ? `${familyName} ${givenName}` : `${givenName} ${familyName}`;\n\n        const user = {\n            personId: roClaims.person_id,\n            byuId: roClaims.byu_id,\n            netId: roClaims.net_id,\n            name: {\n                sortName: roClaims.sort_name,\n                displayName,\n                givenName,\n                familyName,\n                familyNamePosition,\n            },\n            rawUserInfo: json\n        };\n\n        const token = {\n            bearer: accessToken,\n            authorizationHeader: authHeader,\n            expiresAt,\n            client: {\n                id: wso2Claims.client_id,\n                byuId: clientClaims.byu_id,\n                appName: wso2Claims.applicationname,\n            },\n            rawUserInfo: json\n        };\n\n        state(authn.STATE_AUTHENTICATED, token, user);\n    });\n}\n\nconst CLAIMS_PREFIX_RESOURCE_OWNER = 'http://byu.edu/claims/resourceowner_';\nconst CLAIMS_PREFIX_CLIENT = 'http://byu.edu/claims/client_';\nconst CLAIMS_PREFIX_WSO2 = 'http://wso2.org/claims/';\n\nfunction getClaims(userInfo, prefix) {\n    return Object.keys(userInfo).filter(k => k.startsWith(prefix))\n        .reduce((agg, key) => {\n            agg[key.substr(prefix.length)] = userInfo[key];\n            return agg;\n        }, {});\n}\n\nfunction isAuthenticationCallback() {\n    const isCallbackUrl = window.location.href.indexOf(config.callbackUrl) === 0;\n    console.log(window.location.href, config.callbackUrl, window.location.href.indexOf(config.callbackUrl));\n    const hasHash = !!window.location.hash;\n\n    console.log('hasHash', hasHash);\n    if (!isCallbackUrl) {\n        return false;\n    } else if (!hasHash) {\n        return false;\n    }\n    const params = new URLSearchParams(window.location.hash.substring(1));\n    console.log('params', params);\n    if (params.has('access_token') || params.has('error')) {\n        console.log('has params');\n        return true;\n    }\n    return false;\n}\n\nfunction state(state, token, user, error) {\n    store = Object.freeze({ state, token, user, error });\n    dispatch(authn.STATE_CHANGE_EVENT, store);\n}\n\nexport function startLogin() {\n    console.log('startLogin', config);\n\n    const csrf = saveLoginToken(randomString(), {});\n\n    const loginUrl = `https://api.byu.edu/authorize?response_type=token&client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.callbackUrl)}&scope=openid&state=${csrf}`;\n\n    console.log('loginUrl', loginUrl);\n    window.location = loginUrl;\n}\n\nexport function startLogout() {\n    console.log('startLogout');\n}\n\nfunction saveLoginToken(token, pageState) {\n    const value = `${token}.${btoa(JSON.stringify(pageState))}`;\n\n    if (storageAvailable('session')) {\n        window.sessionStorage.setItem('oauth-state', value);\n        return 's.' + token;\n    } else {\n        document.cookie = `oauth-state=${value};max-age=300`;\n        return 'c.' + token;\n    }\n}\n\nexport function startRefresh() {\n    startLogin();\n}\n\nexport function handleStateRequested({ callback }) {\n    callback(store);\n}\n\nfunction storageAvailable(type) {\n    try {\n        var storage = window[type],\n            x = '__storage_test__';\n        storage.setItem(x, x);\n        storage.removeItem(x);\n        return true;\n    }\n    catch (e) {\n        return e instanceof DOMException && (\n            // everything except Firefox\n            e.code === 22 ||\n            // Firefox\n            e.code === 1014 ||\n            // test name field too, because code might not be present\n            // everything except Firefox\n            e.name === 'QuotaExceededError' ||\n            // Firefox\n            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&\n            // acknowledge QuotaExceededError only if there's something already stored\n            storage.length !== 0;\n    }\n}\n\nfunction randomString() {\n    let idArray = Uint32Array.of(1);\n    const crypto = window.crypto || window.msCrypto;\n    crypto.getRandomValues(idArray);\n\n    return new String(idArray[0]);\n}\n\nfunction listen(event, listener) {\n    if (observers.hasOwnProperty(event)) {\n        throw new Error('A listener is already registered for ' + event);\n    }\n    const obs = observers[event] = function (e) { listener(e.detail) };\n    document.addEventListener(event, obs, false);\n}\n\nfunction dispatch(name, detail) {\n    let event;\n    if (typeof window.CustomEvent === 'function') {\n        event = new CustomEvent(name, { detail });\n    } else {\n        event = document.createEvent('CustomEvent');\n        event.initCustomEvent(name, true, false, detail);\n    }\n    document.dispatchEvent(event);\n}\n"],"names":["EVENT_PREFIX","STATE_CHANGE_EVENT","LOGIN_REQUESTED_EVENT","LOGOUT_REQUESTED_EVENT","REFRESH_REQUESTED_EVENT","STATE_REQUESTED_EVENT","STATE_INDETERMINATE","STATE_UNAUTHENTICATED","STATE_AUTHENTICATED","STATE_AUTHENTICATING","STATE_ERROR","store","state","observer","onStateChange","detail","callback","func","e","document","addEventListener","dispatch","offStateChange","removeEventListener","name","event","window","CustomEvent","createEvent","initCustomEvent","dispatchEvent","DEFAULT_ISSUER","config","observers","Object","freeze","authn.STATE_INDETERMINATE","configure","cfg","console","log","Error","clientId","assign","issuer","callbackUrl","location","origin","pathname","requireAuthentication","listen","authn.LOGIN_REQUESTED_EVENT","startLogin","authn.LOGOUT_REQUESTED_EVENT","startLogout","authn.REFRESH_REQUESTED_EVENT","startRefresh","authn.STATE_REQUESTED_EVENT","handleStateRequested","maybeHandleAuthenticationCallback","isAuthenticationCallback","authn.STATE_UNAUTHENTICATED","authn.STATE_AUTHENTICATING","params","URLSearchParams","hash","substring","has","error","type","get","description","uri","authn.STATE_ERROR","accessToken","expiresIn","Number","authHeader","expiresAt","Date","now","fetch","method","headers","Headers","Accept","authorization","mode","then","resp","json","roClaims","getClaims","CLAIMS_PREFIX_RESOURCE_OWNER","clientClaims","CLAIMS_PREFIX_CLIENT","wso2Claims","CLAIMS_PREFIX_WSO2","familyNamePosition","surname_position","givenName","given_name","familyName","family_name","displayName","user","personId","person_id","byuId","byu_id","netId","net_id","sortName","sort_name","rawUserInfo","token","bearer","authorizationHeader","client","id","client_id","appName","applicationname","authn.STATE_AUTHENTICATED","userInfo","prefix","keys","filter","k","startsWith","reduce","agg","key","substr","length","isCallbackUrl","href","indexOf","hasHash","authn.STATE_CHANGE_EVENT","csrf","saveLoginToken","randomString","loginUrl","encodeURIComponent","pageState","value","btoa","JSON","stringify","storageAvailable","sessionStorage","setItem","cookie","storage","x","removeItem","DOMException","code","idArray","Uint32Array","of","crypto","msCrypto","getRandomValues","String","listener","hasOwnProperty","obs"],"mappings":"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"}