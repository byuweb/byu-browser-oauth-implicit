const EVENT_PREFIX="byu-browser-oauth",STATE_CHANGE_EVENT=`${EVENT_PREFIX}-state-changed`,LOGIN_REQUESTED_EVENT=`${EVENT_PREFIX}-login-requested`,LOGOUT_REQUESTED_EVENT=`${EVENT_PREFIX}-logout-requested`,REFRESH_REQUESTED_EVENT=`${EVENT_PREFIX}-refresh-requested`,STATE_REQUESTED_EVENT=`${EVENT_PREFIX}-state-requested`,STATE_INDETERMINATE="indeterminate",STATE_UNAUTHENTICATED="unauthenticated",STATE_AUTHENTICATED="authenticated",STATE_AUTHENTICATING="authenticating",STATE_ERROR="error";let store={state:STATE_INDETERMINATE},observer=onStateChange(e=>{store=e});function onStateChange(e){const t=function(t){e(t.detail)};return document.addEventListener(STATE_CHANGE_EVENT,t,!1),store.state===STATE_INDETERMINATE?dispatch(STATE_REQUESTED_EVENT,{callback:e}):e(store),{offStateChange:function(){document.removeEventListener(STATE_CHANGE_EVENT,t,!1)}}}function dispatch(e,t){let n;"function"==typeof window.CustomEvent?n=new CustomEvent(e,{detail:t}):(n=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!1,t),document.dispatchEvent(n)}const DEFAULT_ISSUER="https://api.byu.edu";let config;const observers={};let store$1=Object.freeze({state:STATE_INDETERMINATE});function configure(e){if(console.log("config",e),!e)throw new Error("cfg must be defined");if(!e.clientId)throw new Error("clientId must be specified");config=Object.assign({issuer:DEFAULT_ISSUER,callbackUrl:`${location.origin}${location.pathname}`,requireAuthentication:!1},e),listen(LOGIN_REQUESTED_EVENT,startLogin),listen(LOGOUT_REQUESTED_EVENT,startLogout),listen(REFRESH_REQUESTED_EVENT,startRefresh),listen(STATE_REQUESTED_EVENT,handleStateRequested),maybeHandleAuthenticationCallback()}function maybeHandleAuthenticationCallback(){if(!isAuthenticationCallback())return console.log("Not an auth callback"),void state$1(STATE_UNAUTHENTICATED);state$1(STATE_AUTHENTICATING);const e=new URLSearchParams(window.location.hash.substring(1));if(e.has("error")){const t={type:e.get("error"),description:e.get("error_description"),uri:e.get("error_uri")};return void state$1(STATE_ERROR,null,null,t)}e.get("state");window.location.hash="";const t=e.get("access_token"),n=Number(e.get("expires_in")),o=`Bearer ${t}`,a=new Date(Date.now()+1e3*n);fetch("https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid",{method:"GET",headers:new Headers({Accept:"application/json",authorization:o}),mode:"cors"}).then(function(e){return e.json()}).then(function(e){console.log("got user info",e);const n=getClaims(e,CLAIMS_PREFIX_RESOURCE_OWNER),i=getClaims(e,CLAIMS_PREFIX_CLIENT),s=getClaims(e,CLAIMS_PREFIX_WSO2);console.log("claims",n,i,s);const r=n.surname_position,E=e.given_name,c=e.family_name,l="F"===r?`${c} ${E}`:`${E} ${c}`,u={personId:n.person_id,byuId:n.byu_id,netId:n.net_id,name:{sortName:n.sort_name,displayName:l,givenName:E,familyName:c,familyNamePosition:r},rawUserInfo:e},T={bearer:t,authorizationHeader:o,expiresAt:a,client:{id:s.client_id,byuId:i.byu_id,appName:s.applicationname},rawUserInfo:e};state$1(STATE_AUTHENTICATED,T,u)})}const CLAIMS_PREFIX_RESOURCE_OWNER="http://byu.edu/claims/resourceowner_",CLAIMS_PREFIX_CLIENT="http://byu.edu/claims/client_",CLAIMS_PREFIX_WSO2="http://wso2.org/claims/";function getClaims(e,t){return Object.keys(e).filter(e=>e.startsWith(t)).reduce((n,o)=>(n[o.substr(t.length)]=e[o],n),{})}function isAuthenticationCallback(){const e=0===window.location.href.indexOf(config.callbackUrl);console.log(window.location.href,config.callbackUrl,window.location.href.indexOf(config.callbackUrl));const t=!!window.location.hash;if(console.log("hasHash",t),!e)return!1;if(!t)return!1;const n=new URLSearchParams(window.location.hash.substring(1));return console.log("params",n),!(!n.has("access_token")&&!n.has("error"))&&(console.log("has params"),!0)}function state$1(e,t,n,o){store$1=Object.freeze({state:e,token:t,user:n,error:o}),dispatch$1(STATE_CHANGE_EVENT,store$1)}function startLogin(){console.log("startLogin",config);const e=saveLoginToken(randomString(),{}),t=`https://api.byu.edu/authorize?response_type=token&client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.callbackUrl)}&scope=openid&state=${e}`;console.log("loginUrl",t),window.location=t}function startLogout(){console.log("startLogout")}function saveLoginToken(e,t){const n=`${e}.${btoa(JSON.stringify(t))}`;return storageAvailable("session")?(window.sessionStorage.setItem("oauth-state",n),"s."+e):(document.cookie=`oauth-state=${n};max-age=300`,"c."+e)}function startRefresh(){startLogin()}function handleStateRequested({callback:e}){e(store$1)}function storageAvailable(e){try{var t=window[e],n="__storage_test__";return t.setItem(n,n),t.removeItem(n),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==t.length}}function randomString(){let e=Uint32Array.of(1);return(window.crypto||window.msCrypto).getRandomValues(e),new String(e[0])}function listen(e,t){if(observers.hasOwnProperty(e))throw new Error("A listener is already registered for "+e);const n=observers[e]=function(e){t(e.detail)};document.addEventListener(e,n,!1)}function dispatch$1(e,t){let n;"function"==typeof window.CustomEvent?n=new CustomEvent(e,{detail:t}):(n=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!1,t),document.dispatchEvent(n)}export{DEFAULT_ISSUER,configure,startLogin,startLogout,startRefresh,handleStateRequested};
//# sourceMappingURL=implicit-grant.min.js.map
