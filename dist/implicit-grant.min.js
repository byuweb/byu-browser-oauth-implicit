const EVENT_PREFIX="byu-browser-oauth",EVENT_STATE_CHANGE=`${EVENT_PREFIX}-state-changed`,EVENT_LOGIN_REQUESTED=`${EVENT_PREFIX}-login-requested`,EVENT_LOGOUT_REQUESTED=`${EVENT_PREFIX}-logout-requested`,EVENT_REFRESH_REQUESTED=`${EVENT_PREFIX}-refresh-requested`,EVENT_CURRENT_INFO_REQUESTED=`${EVENT_PREFIX}-current-info-requested`,STATE_INDETERMINATE="indeterminate",STATE_UNAUTHENTICATED="unauthenticated",STATE_AUTHENTICATED="authenticated",STATE_AUTHENTICATING="authenticating",STATE_ERROR="error",DEFAULT_ISSUER="https://api.byu.edu";let config;const observers={};let store=Object.freeze({state:"indeterminate"});function configure(e){if(console.log("config",e),!e)throw new Error("cfg must be defined");if(!e.clientId)throw new Error("clientId must be specified");config=Object.assign({issuer:DEFAULT_ISSUER,callbackUrl:`${location.origin}${location.pathname}`,requireAuthentication:!1},e),listen(EVENT_LOGIN_REQUESTED,startLogin),listen(EVENT_LOGOUT_REQUESTED,startLogout),listen(EVENT_REFRESH_REQUESTED,startRefresh),listen(EVENT_CURRENT_INFO_REQUESTED,handleCurrentInfoRequest),maybeHandleAuthenticationCallback()}function maybeHandleAuthenticationCallback(){if(!isAuthenticationCallback())return console.log("Not an auth callback"),void state(STATE_UNAUTHENTICATED);state(STATE_AUTHENTICATING);const e=new URLSearchParams(window.location.hash.substring(1));if(e.has("error")){const t={type:e.get("error"),description:e.get("error_description"),uri:e.get("error_uri")};return void state(STATE_ERROR,null,null,t)}const t=e.get("state");let o;window.location.hash="";try{o=validateCsrfAndGetPageData(t)}catch(e){return void state(STATE_ERROR,null,null,{type:"oauth-state-mismatch",description:e.message||e})}clearSavedStateFor("s");const n=e.get("access_token"),a=Number(e.get("expires_in")),r=`Bearer ${n}`,i=new Date(Date.now()+1e3*a);fetch("https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid",{method:"GET",headers:new Headers({Accept:"application/json",authorization:r}),mode:"cors"}).then(function(e){return e.json()}).then(function(e){console.log("got user info",e);const t=getClaims(e,CLAIMS_PREFIX_RESOURCE_OWNER),o=getClaims(e,CLAIMS_PREFIX_CLIENT),a=getClaims(e,CLAIMS_PREFIX_WSO2);console.log("claims",t,o,a);const s=t.surname_position,c=e.given_name,E=e.family_name,l="F"===s?`${E} ${c}`:`${c} ${E}`,u={personId:t.person_id,byuId:t.byu_id,netId:t.net_id,name:{sortName:t.sort_name,displayName:l,givenName:c,familyName:E,familyNamePosition:s},rawUserInfo:e},d={bearer:n,authorizationHeader:r,expiresAt:i,client:{id:a.client_id,byuId:o.byu_id,appName:a.applicationname},rawUserInfo:e};state(STATE_AUTHENTICATED,d,u)})}const CLAIMS_PREFIX_RESOURCE_OWNER="http://byu.edu/claims/resourceowner_",CLAIMS_PREFIX_CLIENT="http://byu.edu/claims/client_",CLAIMS_PREFIX_WSO2="http://wso2.org/claims/";function getClaims(e,t){return Object.keys(e).filter(e=>e.startsWith(t)).reduce((o,n)=>(o[n.substr(t.length)]=e[n],o),{})}function isAuthenticationCallback(){const e=0===window.location.href.indexOf(config.callbackUrl);console.log(window.location.href,config.callbackUrl,window.location.href.indexOf(config.callbackUrl));const t=!!window.location.hash;if(console.log("hasHash",t),!e)return!1;if(!t)return!1;const o=new URLSearchParams(window.location.hash.substring(1));return console.log("params",o),!(!o.has("access_token")&&!o.has("error"))&&(console.log("has params"),!0)}function state(e,t,o,n){store=Object.freeze({state:e,token:t,user:o,error:n}),dispatch(EVENT_STATE_CHANGE,store)}function startLogin(){console.log("startLogin",config);const e=saveLoginToken(randomString(),{});console.log("csrf",e);const t=`https://api.byu.edu/authorize?response_type=token&client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.callbackUrl)}&scope=openid&state=${e}`;console.log("loginUrl",t),window.location=t}function startLogout(){console.log("startLogout"),window.location="http://api.byu.edu/logout?redirect_url="+config.callbackUrl}function saveLoginToken(e,t){const o=getStorageName(config.clientId),n=`${e}.${btoa(JSON.stringify(t))}`;let a;return storageAvailable("sessionStorage")?(window.sessionStorage.setItem(o,n),a=TOKEN_STORE_TYPE_SESSION):(document.cookie=`${o}=${n};max-age=300`,a=TOKEN_STORE_TYPE_COOKIE),a+"."+e}function getStorageName(e){return`oauth-state-${encodeURIComponent(e)}`}const TOKEN_STORE_TYPE_SESSION="s",TOKEN_STORE_TYPE_COOKIE="c";function validateCsrfAndGetPageData(e){const[t,o]=e.split("."),n=getSavedStateFor(t);if(0===n.length)throw console.error("No OAuth state has been stored, or it has expired"),new Error("Your authentication session has expired or something has gone wrong.");const a=n.map(e=>e.split(".")).find(([e,t])=>e===o);if(!a)throw console.error("Authentication state mismatch - no saved values match CSRF token"),new Error("Your saved authentication information does not match. Please try again.");const r=a[1];return JSON.parse(atob(r))}function getSavedStateFor(e){const t=getStorageName(config.clientId);switch(e){case TOKEN_STORE_TYPE_SESSION:return[window.sessionStorage.getItem(t)];case TOKEN_STORE_TYPE_COOKIE:const o=[];return(document.cookie||"").split(";").map(e=>e.trim()).forEach(e=>{0===e.indexOf(t+"=")&&o.push(e.split("=",2)[1])}),o}}function clearSavedStateFor(e){const t=getStorageName(config.clientId);switch(e){case TOKEN_STORE_TYPE_SESSION:window.sessionStorage.removeItem(t);break;case TOKEN_STORE_TYPE_COOKIE:document.cookie=t+"=null;expires=Thu, 01 Jan 1970 00:00:00 GMT"}}function startRefresh(){startLogin()}function handleCurrentInfoRequest({callback:e}){e(store)}function storageAvailable(e){try{var t=window[e],o="__storage_test__";return t.setItem(o,o),t.removeItem(o),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==t.length}}function randomString(){let e=new Uint32Array(3);return(window.crypto||window.msCrypto).getRandomValues(e),e.reduce((e,t)=>e+t.toString(16),"")}function listen(e,t){if(console.log("listening to",e),observers.hasOwnProperty(e))throw new Error("A listener is already registered for "+e);const o=observers[e]=function(e){t(e.detail)};document.addEventListener(e,o,!1)}function dispatch(e,t){let o;"function"==typeof window.CustomEvent?o=new CustomEvent(e,{detail:t}):(o=document.createEvent("CustomEvent")).initCustomEvent(e,!0,!1,t),document.dispatchEvent(o)}export{DEFAULT_ISSUER,configure,startLogin,startLogout,startRefresh,handleCurrentInfoRequest};
//# sourceMappingURL=implicit-grant.min.js.map
