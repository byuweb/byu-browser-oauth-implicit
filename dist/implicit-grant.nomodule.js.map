{"version":3,"file":"implicit-grant.nomodule.js","sources":["../src/log.js","../node_modules/@byuweb/browser-oauth/constants.js","../node_modules/cookie/index.js","../node_modules/local-storage-fallback/lib/CookieStorage.js","../node_modules/local-storage-fallback/lib/isSupported.js","../node_modules/local-storage-fallback/lib/MemoryStorage.js","../node_modules/local-storage-fallback/lib/index.js","../src/local-storage.js","../src/provider.js","../src/implicit-grant.js"],"sourcesContent":["const LEVEL_TRACE = { priority: 0, name: \"trace\", run: handleTrace };\nconst LEVEL_DEBUG = { priority: 1, name: \"debug\", run: handleDebug };\nconst LEVEL_INFO = { priority: 10, name: \"info\", run: handleInfo };\nconst LEVEL_ERROR = { priority: 100, name: \"error\", run: handleError };\n\nconst ALL_LEVELS = [LEVEL_TRACE, LEVEL_DEBUG, LEVEL_INFO, LEVEL_ERROR];\nconst DEFAULT_LEVEL = LEVEL_ERROR;\n\nexport function debug(...args) {\n  log(LEVEL_DEBUG, ...args);\n}\n\nexport function info(...args) {\n  log(LEVEL_INFO, ...args);\n}\n\nexport function error(...args) {\n  log(LEVEL_ERROR, ...args);\n}\n\nexport function debugf(format, ...args) {\n  logf(LEVEL_DEBUG, format, ...args);\n}\n\nexport function infof(format, ...args) {\n  logf(LEVEL_INFO, format, ...args);\n}\n\nexport function errorf(format, ...args) {\n  logf(LEVEL_ERROR, format, ...args);\n}\n\nfunction logf(level, format, ...args) {\n  if (!shouldLog(level)) {\n    return;\n  }\n  level.run(\n    `[byu-browser-oauth-implicit] [${level.name}] (${getFormattedTime()}) ${format}`,\n    ...args\n  );\n}\n\nfunction log(level, ...args) {\n  if (!shouldLog(level)) {\n    return;\n  }\n  level.run(\n    \"[byu-browser-oauth-implicit]\",\n    `[${level.name}]`,\n    `(${getFormattedTime()})`,\n    ...args\n  );\n}\n\nfunction getFormattedTime() {\n  const now = new Date();\n  const h24 = String(now.getHours()).padStart(2, '0');\n  const min = String(now.getMinutes()).padStart(2, '0');\n  const sec = String(now.getSeconds()).padStart(2, '0');\n  const millis = String(now.getMilliseconds()).padStart(3, '0');\n\n  return `${h24}:${min}:${sec},${millis}${formatTimezone(now)}`;\n}\n\nfunction formatTimezone(date) {\n  const offset = date.getTimezoneOffset();\n  if (offset === 0) {\n    return 'Z';\n  }\n  const nonNegative = offset >= 0;\n  const absOffset = Math.abs(offset);\n\n  // Positive whole offset hours\n  const hourInt = Math.floor(absOffset / 60);\n  const hourDone = String(hourInt).padStart(2, '0')\n  const sign = (nonNegative ? '+' : '-');\n  const minDone = String(absOffset % 60).padStart(2, '0');\n\n  return `${sign}${hourDone}${minDone}`;\n}\n\nfunction shouldLog(level) {\n  return level.priority >= currentLevel().priority;\n}\n\nfunction currentLevel() {\n  const name = levelAttr() || levelGlobalVar();\n  if (!name) {\n    return DEFAULT_LEVEL;\n  }\n  const lower = name.toLowerCase();\n  return (\n    ALL_LEVELS.find(function(l) {\n      return l.name === lower;\n    }) || DEFAULT_LEVEL\n  );\n}\n\nfunction levelAttr() {\n  return document.documentElement.getAttribute(\"byu-oauth-logging\");\n}\n\nfunction levelGlobalVar() {\n  const o = window.byuOAuth || {};\n  return o.logging;\n}\n\nfunction handleTrace(...args) {\n  if (console.trace) {\n    console.trace(...args);\n  } else {\n    console.log(...args);\n  }\n}\n\nfunction handleDebug(...args) {\n  console.log(...args);\n}\n\nfunction handleInfo(...args) {\n  if (console.info) {\n    console.info(...args);\n  } else {\n    console.log(...args);\n  }\n}\n\nfunction handleError(...args) {\n  if (console.error) {\n    console.error(...args);\n  } else {\n    console.log(...args);\n  }\n}\n","export const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const EVENT_STATE_CHANGE = `${EVENT_PREFIX}-state-changed`;\nexport const EVENT_LOGIN_REQUESTED = `${EVENT_PREFIX}-login-requested`;\nexport const EVENT_LOGOUT_REQUESTED = `${EVENT_PREFIX}-logout-requested`;\nexport const EVENT_REFRESH_REQUESTED = `${EVENT_PREFIX}-refresh-requested`;\nexport const EVENT_CURRENT_INFO_REQUESTED = `${EVENT_PREFIX}-current-info-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\n","/*!\n * cookie\n * Copyright(c) 2012-2014 Roman Shtylman\n * Copyright(c) 2015 Douglas Christopher Wilson\n * MIT Licensed\n */\n\n'use strict';\n\n/**\n * Module exports.\n * @public\n */\n\nexports.parse = parse;\nexports.serialize = serialize;\n\n/**\n * Module variables.\n * @private\n */\n\nvar decode = decodeURIComponent;\nvar encode = encodeURIComponent;\nvar pairSplitRegExp = /; */;\n\n/**\n * RegExp to match field-content in RFC 7230 sec 3.2\n *\n * field-content = field-vchar [ 1*( SP / HTAB ) field-vchar ]\n * field-vchar   = VCHAR / obs-text\n * obs-text      = %x80-FF\n */\n\nvar fieldContentRegExp = /^[\\u0009\\u0020-\\u007e\\u0080-\\u00ff]+$/;\n\n/**\n * Parse a cookie header.\n *\n * Parse the given cookie header string into an object\n * The object has the various cookies as keys(names) => values\n *\n * @param {string} str\n * @param {object} [options]\n * @return {object}\n * @public\n */\n\nfunction parse(str, options) {\n  if (typeof str !== 'string') {\n    throw new TypeError('argument str must be a string');\n  }\n\n  var obj = {}\n  var opt = options || {};\n  var pairs = str.split(pairSplitRegExp);\n  var dec = opt.decode || decode;\n\n  for (var i = 0; i < pairs.length; i++) {\n    var pair = pairs[i];\n    var eq_idx = pair.indexOf('=');\n\n    // skip things that don't look like key=value\n    if (eq_idx < 0) {\n      continue;\n    }\n\n    var key = pair.substr(0, eq_idx).trim()\n    var val = pair.substr(++eq_idx, pair.length).trim();\n\n    // quoted values\n    if ('\"' == val[0]) {\n      val = val.slice(1, -1);\n    }\n\n    // only assign once\n    if (undefined == obj[key]) {\n      obj[key] = tryDecode(val, dec);\n    }\n  }\n\n  return obj;\n}\n\n/**\n * Serialize data into a cookie header.\n *\n * Serialize the a name value pair into a cookie string suitable for\n * http headers. An optional options object specified cookie parameters.\n *\n * serialize('foo', 'bar', { httpOnly: true })\n *   => \"foo=bar; httpOnly\"\n *\n * @param {string} name\n * @param {string} val\n * @param {object} [options]\n * @return {string}\n * @public\n */\n\nfunction serialize(name, val, options) {\n  var opt = options || {};\n  var enc = opt.encode || encode;\n\n  if (typeof enc !== 'function') {\n    throw new TypeError('option encode is invalid');\n  }\n\n  if (!fieldContentRegExp.test(name)) {\n    throw new TypeError('argument name is invalid');\n  }\n\n  var value = enc(val);\n\n  if (value && !fieldContentRegExp.test(value)) {\n    throw new TypeError('argument val is invalid');\n  }\n\n  var str = name + '=' + value;\n\n  if (null != opt.maxAge) {\n    var maxAge = opt.maxAge - 0;\n    if (isNaN(maxAge)) throw new Error('maxAge should be a Number');\n    str += '; Max-Age=' + Math.floor(maxAge);\n  }\n\n  if (opt.domain) {\n    if (!fieldContentRegExp.test(opt.domain)) {\n      throw new TypeError('option domain is invalid');\n    }\n\n    str += '; Domain=' + opt.domain;\n  }\n\n  if (opt.path) {\n    if (!fieldContentRegExp.test(opt.path)) {\n      throw new TypeError('option path is invalid');\n    }\n\n    str += '; Path=' + opt.path;\n  }\n\n  if (opt.expires) {\n    if (typeof opt.expires.toUTCString !== 'function') {\n      throw new TypeError('option expires is invalid');\n    }\n\n    str += '; Expires=' + opt.expires.toUTCString();\n  }\n\n  if (opt.httpOnly) {\n    str += '; HttpOnly';\n  }\n\n  if (opt.secure) {\n    str += '; Secure';\n  }\n\n  if (opt.sameSite) {\n    var sameSite = typeof opt.sameSite === 'string'\n      ? opt.sameSite.toLowerCase() : opt.sameSite;\n\n    switch (sameSite) {\n      case true:\n        str += '; SameSite=Strict';\n        break;\n      case 'lax':\n        str += '; SameSite=Lax';\n        break;\n      case 'strict':\n        str += '; SameSite=Strict';\n        break;\n      default:\n        throw new TypeError('option sameSite is invalid');\n    }\n  }\n\n  return str;\n}\n\n/**\n * Try decoding a string using a decoding function.\n *\n * @param {string} str\n * @param {function} decode\n * @private\n */\n\nfunction tryDecode(str, decode) {\n  try {\n    return decode(str);\n  } catch (e) {\n    return str;\n  }\n}\n","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nexports.hasCookies = hasCookies;\n\nvar _cookie = require('cookie');\n\nvar _cookie2 = _interopRequireDefault(_cookie);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar prefix = 'lS_';\n\nvar CookieStorage = function () {\n  function CookieStorage() {\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, CookieStorage);\n\n    this.cookieOptions = Object.assign({ path: '/' }, options);\n    prefix = options.prefix === undefined ? prefix : options.prefix;\n  }\n\n  _createClass(CookieStorage, [{\n    key: 'getItem',\n    value: function getItem(key) {\n      var cookies = _cookie2.default.parse(document.cookie);\n      if (!cookies || !cookies.hasOwnProperty(prefix + key)) {\n        return null;\n      }\n      return cookies[prefix + key];\n    }\n  }, {\n    key: 'setItem',\n    value: function setItem(key, value) {\n      document.cookie = _cookie2.default.serialize(prefix + key, value, this.cookieOptions);\n      return value;\n    }\n  }, {\n    key: 'removeItem',\n    value: function removeItem(key) {\n      var options = Object.assign({}, this.cookieOptions, { maxAge: -1 });\n      document.cookie = _cookie2.default.serialize(prefix + key, '', options);\n      return null;\n    }\n  }, {\n    key: 'clear',\n    value: function clear() {\n      var cookies = _cookie2.default.parse(document.cookie);\n      for (var key in cookies) {\n        if (key.indexOf(prefix) === 0) {\n          this.removeItem(key.substr(prefix.length));\n        }\n      }\n\n      return null;\n    }\n  }]);\n\n  return CookieStorage;\n}();\n\nexports.default = CookieStorage;\nfunction hasCookies() {\n  var storage = new CookieStorage();\n\n  try {\n    var TEST_KEY = '__test';\n    storage.setItem(TEST_KEY, '1');\n    var value = storage.getItem(TEST_KEY);\n    storage.removeItem(TEST_KEY);\n\n    return value === '1';\n  } catch (e) {\n    return false;\n  }\n}","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = isSupported;\n\nvar _CookieStorage = require('./CookieStorage');\n\nvar TEST_KEY = '__test';\n\nfunction hasStorage(name) {\n  try {\n    var storage = window[name];\n    storage.setItem(TEST_KEY, '1');\n    storage.removeItem(TEST_KEY);\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction isSupported() {\n  var name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'localStorage';\n\n  var storage = String(name).replace(/storage$/i, '').toLowerCase();\n\n  if (storage === 'local') {\n    return hasStorage('localStorage');\n  }\n\n  if (storage === 'session') {\n    return hasStorage('sessionStorage');\n  }\n\n  if (storage === 'cookie') {\n    return (0, _CookieStorage.hasCookies)();\n  }\n\n  if (storage === 'memory') {\n    return true;\n  }\n\n  throw new Error('Storage method `' + name + '` is not available.\\n    Please use one of the following: localStorage, sessionStorage, cookieStorage, memoryStorage.');\n}","\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar MemoryStorage = function () {\n  function MemoryStorage() {\n    _classCallCheck(this, MemoryStorage);\n\n    this._data = {};\n  }\n\n  _createClass(MemoryStorage, [{\n    key: \"getItem\",\n    value: function getItem(key) {\n      return this._data.hasOwnProperty(key) ? this._data[key] : null;\n    }\n  }, {\n    key: \"setItem\",\n    value: function setItem(key, value) {\n      return this._data[key] = String(value);\n    }\n  }, {\n    key: \"removeItem\",\n    value: function removeItem(key) {\n      return delete this._data[key];\n    }\n  }, {\n    key: \"clear\",\n    value: function clear() {\n      return this._data = {};\n    }\n  }]);\n\n  return MemoryStorage;\n}();\n\nexports.default = MemoryStorage;","'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.MemoryStorage = exports.CookieStorage = exports.isSupported = exports.storage = undefined;\n\nvar _isSupported = require('./isSupported');\n\nvar _isSupported2 = _interopRequireDefault(_isSupported);\n\nvar _CookieStorage = require('./CookieStorage');\n\nvar _CookieStorage2 = _interopRequireDefault(_CookieStorage);\n\nvar _MemoryStorage = require('./MemoryStorage');\n\nvar _MemoryStorage2 = _interopRequireDefault(_MemoryStorage);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar storage = null;\n\nif ((0, _isSupported2.default)('localStorage')) {\n  // use localStorage\n  exports.storage = storage = window.localStorage;\n} else if ((0, _isSupported2.default)('sessionStorage')) {\n  // use sessionStorage\n  exports.storage = storage = window.sessionStorage;\n} else if ((0, _isSupported2.default)('cookieStorage')) {\n  // use cookies\n  exports.storage = storage = new _CookieStorage2.default();\n} else {\n  // use memory\n  exports.storage = storage = new _MemoryStorage2.default();\n}\n\nexports.default = storage;\nexports.storage = storage;\nexports.isSupported = _isSupported2.default;\nexports.CookieStorage = _CookieStorage2.default;\nexports.MemoryStorage = _MemoryStorage2.default;","/*\n *  @license\n *    Copyright 2018 Brigham Young University\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *        http://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\n\n\"use strict\";\n\nimport storage from 'local-storage-fallback';\n// During initial page load, Firefox \"LocalStorage\" is wonky if in Private Browsing.\n// Fortunately, the \"OAuth State\" data is tiny (one date and one 16-character string),\n// so it won't hit any Cookie size limitations.\n// With those factors in mind, we intentionally downgrade to Cookie storage for initial OAuth data storage\nimport { CookieStorage } from 'local-storage-fallback';\n\nconst cookie = new CookieStorage();\n\nexport class StorageHandler {\n\n  saveOAuthState(clientId, state) {\n    cookie.setItem(getKey(clientId), JSON.stringify(state));\n  }\n\n  getOAuthState(clientId) {\n    const result = cookie.getItem(getKey(clientId));\n    if (!result) {\n      return null;\n    }\n    return JSON.parse(result);\n  }\n\n  clearOAuthState(clientId) {\n    cookie.removeItem(getKey(clientId));\n  }\n\n  saveSessionState(clientId, state) {\n    storage.setItem(getSessionKey(clientId), JSON.stringify(state));\n  }\n\n  getSessionState(clientId) {\n    const key = getSessionKey(clientId);\n    const stored = storage.getItem(key);\n    if (!stored) {\n      return null;\n    }\n    return JSON.parse(stored);\n  }\n\n  clearSessionState(clientId) {\n    storage.removeItem(getSessionKey(clientId));\n  }\n}\n\nfunction getKey(clientId) {\n  return 'oauth-state-' + encodeURIComponent(clientId);\n}\n\nfunction getSessionKey(clientId) {\n  return getKey(clientId) + '-active-session';\n}\n\n","/*\n *  @license\n *    Copyright 2018 Brigham Young University\n *\n *    Licensed under the Apache License, Version 2.0 (the \"License\");\n *    you may not use this file except in compliance with the License.\n *    You may obtain a copy of the License at\n *\n *        http://www.apache.org/licenses/LICENSE-2.0\n *\n *    Unless required by applicable law or agreed to in writing, software\n *    distributed under the License is distributed on an \"AS IS\" BASIS,\n *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *    See the License for the specific language governing permissions and\n *    limitations under the License.\n */\n\"use strict\";\n\nimport * as log from './log.js';\nimport * as authn from '@byuweb/browser-oauth/constants.js';\nimport {StorageHandler} from \"./local-storage.js\";\n// NOTE: not using browser `crypto` module, because `crypto.subtle` isn't available when the browser isn't in HTTPS,\n// and our development environments usually use plain HTTP. We're only doing a single one-way hash, so performance\n// isn't a big deal\nimport sha256Lib from 'js-sha256'\nconst sha256 = sha256Lib.sha256\n\nlet SINGLETON_INSTANCE;\nlet BASE_URL;\n\nconst CHILD_IFRAME_ID = 'byu-oauth-implicit-grant-refresh-iframe'\nconst STORED_STATE_LIFETIME = 5 * 60 * 1000; // 5 minutes (in milliseconds)\nconst EXPIRATION_BUFFER = (5 * 60) + 5; // 5 minutes + 5 seconds (in seconds)\nexport const IG_STATE_AUTO_REFRESH_FAILED = 'implicit-grant-auto-refresh-failed'\n\nexport class ImplicitGrantProvider {\n  constructor(config, window, document, storageHandler = new StorageHandler()) {\n    log.debug('initializing provider with config', config);\n    this.config = config;\n    this.window = window;\n    this.document = document;\n    this.storageHandler = storageHandler;\n    this._listeners = {};\n\n    BASE_URL = this.config.baseUrl.replace(/\\/+$/, '') // strip trailing slash(es)\n\n    this.store = Object.freeze({\n      state: authn.STATE_INDETERMINATE,\n      user: null,\n      token: null,\n      error: null\n    });\n    log.debug('initialized provider');\n  }\n\n  _changeState(state, user, token, error) {\n    logStateChange(state, user, token, error);\n    this.store = Object.freeze({\n      state, user, token, error\n    });\n    _dispatchEvent(this, authn.EVENT_STATE_CHANGE, this.store);\n  }\n\n  _checkPopupOpener() {\n    try {\n      const origin = this.window.opener.location.origin\n      if (origin === (new URL(this.config.callbackUrl)).origin) { // Origins match\n        return this.window.opener\n      }\n    } catch (e) {\n      // Failed to get window.opener.location.origin, so we must have been opened\n      // from a different origin.\n      // Fall through to the \"return false\" outside this try/catch block\n    }\n    return false\n  }\n\n  _checkIframeOpener() {\n    try {\n      const iframe = this.window.parent.document.getElementById(CHILD_IFRAME_ID)\n      if (iframe && iframe.contentWindow === this.window) {\n        return iframe\n      }\n    } catch (e) {\n      // Failed to access window.parent info, so we must be in an iframe from a different\n      // origin.\n      // Fall through to the \"return false\" outside this try/catch block\n    }\n    return false\n  }\n\n  // Separate state change listener, because state change events\n  // might come from child iframe/popup window\n  handleStateChange({ state, user, token, source }) {\n    log.debug('in handleStateChange', state);\n\n    const opener = this._checkPopupOpener()\n    // If this is a popup\n    if (opener) {\n      // We're inside a child re-authentication popup\n\n      if (source) {\n        // event was triggered by a child, so ignore since we're inside a child\n        return\n      }\n\n      log.debug('dispatching event to parent');\n      // Pass event along to parent\n      _dispatchEvent(opener, authn.EVENT_STATE_CHANGE, { state, token, user, source: 'popup' })\n\n      if (state === authn.STATE_AUTHENTICATED) {\n        // delete self now that authentication is complete\n        log.info('closing self');\n        this.window.close()\n      }\n\n      return\n    }\n\n    const iframe = this._checkIframeOpener()\n    // If we're inside a \"refresh\" iframe\n    if (iframe) {\n      if (source) {\n        // event was triggered by a child, so ignore since we're inside a child\n        return\n      }\n\n      log.debug('dispatching event to parent');\n      // Pass event along to parent\n      _dispatchEvent(this.window.parent, authn.EVENT_STATE_CHANGE, { state, token, user, source: 'iframe' })\n\n      if (state === authn.STATE_AUTHENTICATED) {\n        // delete self now that authentication is complete\n        log.info('removing child iframe');\n        iframe.parentNode.removeChild(iframe)\n      }\n\n      return\n    }\n\n    this._maybeUpdateStoredSession(state, user, token);\n\n    if (state === authn.STATE_AUTHENTICATED) {\n      this._checkExpired(token.expiresAt.getTime())\n    }\n  }\n\n  async startup() {\n    ensureOnlyInstance(this);\n    log.info('starting up');\n    this.listen();\n    this._changeState(authn.STATE_INDETERMINATE);\n\n    const location = this._location;\n\n    if (this.isAuthenticationCallback(location)) {\n      log.debug('handling authentication callback');\n      this._changeState(authn.STATE_AUTHENTICATING);\n      try {\n        const {state, user, token, error} = await _handleAuthenticationCallback(\n          this.config,\n          location,\n          this.storageHandler\n        );\n        this._changeState(state, user, token, error);\n      } catch (err) {\n        log.error('OAuth Error', err);\n        this._changeState(authn.STATE_ERROR, undefined, undefined, err);\n      }\n    } else if (this.hasStoredSession()) {\n      log.debug('Has stored session');\n      this._updateStateFromStorage();\n    } else {\n      log.debug('no authentication present');\n      this._changeState(authn.STATE_UNAUTHENTICATED);\n    }\n    return this;\n  }\n\n  _checkExpired(expirationTimeInMs) {\n    const expiresInMs = expirationTimeInMs - Date.now()\n\n    log.debug(`checking expiration time; expires in ${expiresInMs} ms, ${new Date(expirationTimeInMs)}`);\n\n    if (expiresInMs > (30 * 1000)) { // 30 second buffer before token actually expires\n      if (this.__expirationTask) {\n        clearTimeout(this.__expirationTask);\n      }\n      // Simply using setTimeout for an hour in the future\n      // doesn't work; setTimeout isn't that precise over that long of a period.\n      // So re-check every five seconds until we're past the expiration time\n      this.__expirationTask = setTimeout(() =>  {\n        this.__expirationTask = null;\n        this._checkExpired(expirationTimeInMs);\n      }, 5000);\n\n      return;\n    }\n\n    if (this.config.autoRefreshOnTimeout) {\n      this.startRefresh('iframe');\n    } else {\n      // We don't have auto-refresh enabled, so flag the token as expired and let the application handle it.\n      this._changeState(authn.STATE_EXPIRED, this.store.user, this.store.token);\n    }\n  }\n\n  get _location() {\n    return this.window.location;\n  }\n\n  isAuthenticationCallback(location) {\n    const isCallbackUrl = location.href.indexOf(this.config.callbackUrl) === 0;\n    const hasCode = location.search && location.search.includes('code=') && location.search.includes('state=')\n\n    return !!(isCallbackUrl && hasCode)\n  }\n\n  hasStoredSession() {\n    return !!this.storageHandler.getSessionState(this.config.clientId);\n  }\n\n  shutdown() {\n    log.info('shutting down');\n    this.unlisten();\n    this._changeState(authn.STATE_INDETERMINATE);\n    cleanupOnlyInstance(this);\n  }\n\n  listen() {\n    log.debug('setting up event listeners');\n    _listenTo(this, authn.EVENT_LOGIN_REQUESTED, this.startLogin);\n    _listenTo(this, authn.EVENT_LOGOUT_REQUESTED, this.startLogout);\n    _listenTo(this, authn.EVENT_REFRESH_REQUESTED, this.startRefresh);\n    _listenTo(this, authn.EVENT_CURRENT_INFO_REQUESTED, this.handleCurrentInfoRequest);\n    _listenTo(this, authn.EVENT_STATE_CHANGE, this.handleStateChange);\n  }\n\n  unlisten() {\n    log.debug('tearing down event listeners');\n    _unlistenTo(this, authn.EVENT_LOGIN_REQUESTED);\n    _unlistenTo(this, authn.EVENT_LOGOUT_REQUESTED);\n    _unlistenTo(this, authn.EVENT_REFRESH_REQUESTED);\n    _unlistenTo(this, authn.EVENT_CURRENT_INFO_REQUESTED);\n    _unlistenTo(this, authn.EVENT_STATE_CHANGE);\n  }\n\n  startLogin(displayType = 'window') {\n    log.infof('Starting login. mode=%s', displayType);\n    const {clientId, callbackUrl} = this.config;\n    const csrf = randomString();\n    const codeVerifier = randomString(128);\n    // challenge is base64-encoded SHA256 hash of codeVerifier\n    const codeChallenge = btoa(String.fromCharCode(...sha256.array(codeVerifier)))\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/=/g, '')\n\n    const storedState = _prepareStoredState(Date.now() + STORED_STATE_LIFETIME, csrf, codeVerifier, {});\n    this.storageHandler.saveOAuthState(this.config.clientId, storedState);\n\n    const loginUrl = `${BASE_URL}/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(callbackUrl)}&scope=openid&state=${csrf}&code_challenge=${codeChallenge}&code_challenge_method=S256`;\n    log.debug('computed login url of', loginUrl);\n\n    if (!displayType || displayType == 'window') {\n      log.info(`Redirecting user to '${loginUrl}'`);\n      this.window.location = loginUrl;\n      return\n    } else if (displayType === 'popup') {\n      log.info('launching popup at', loginUrl);\n      this.window.open(loginUrl)\n      return\n    }\n\n    log.info('Setting up hidden refresh iframe at', loginUrl);\n    // last option: displayType == 'iframe'\n    let iframe = this.document.getElementById(CHILD_IFRAME_ID)\n    if (iframe) {\n      iframe.parentNode.removeChild(iframe)\n    }\n    iframe = this.document.createElement('iframe')\n    iframe.onload = () => {\n      let html = null\n      try {\n        html = iframe.contentWindow.document.body.innerHTML\n      } catch (err) {\n        // intentional do-nothing\n      }\n      if (html === null) {\n        // Hidden-frame refresh failed. Remove frame and\n        // report problem\n        iframe.parentNode.removeChild(iframe)\n        this._changeState(IG_STATE_AUTO_REFRESH_FAILED, null, null)\n        this._changeState(authn.STATE_UNAUTHENTICATED, null, null)\n      }\n    }\n    iframe.id = CHILD_IFRAME_ID\n    iframe.src = loginUrl\n    iframe.style = 'display:none'\n    log.debug('appending iframe', iframe);\n    this.document.body.appendChild(iframe);\n  }\n\n  startLogout() {\n    log.info('starting logout');\n    this.storageHandler.clearSessionState(this.config.clientId);\n    // Need to ensure BOTH api.byu.edu and cas.byu.edu clean out their sessions\n    // With current config of those two sites, to have that full clean out AND a final \"where to go after logout\"\n    // redirect, we need to manually wrap them all together\n    const logoutRedirect = (this.config.logoutRedirect === undefined) ? this.config.callbackUrl : this.config.logoutRedirect\n    const casLogoutUrl = 'https://cas.byu.edu/cas/logout?service=' + encodeURIComponent(logoutRedirect)\n    const logoutUrl = `${BASE_URL}/logout?redirect_url=` + encodeURIComponent(casLogoutUrl);\n    log.info('logging out by redirecting to', logoutUrl);\n    this.window.location = logoutUrl;\n\n    //TODO: WSO2 Identity Server 5.1 allows us to revoke implicit tokens.  Once that's done, we'll need to do this.\n    // const url = `https://api.byu.edu/revoke`;\n\n    // const form = new URLSearchParams();\n    // form.set('token', store.token.bearer);\n    // form.set('client_id', config.clientId);\n    // form.set('token_type_hint', 'access_token');\n\n    // console.log('logout url', url);\n\n    // fetch(url, {\n    //     method: 'POST',\n    //     body: form,\n    //     // headers: {\n    //     //     'Content-Type': 'application/x-www-form-urlencoded'\n    //     // }\n    // }).then(result => {\n    //     console.log('done with logout', result);\n    // });\n  }\n\n  async startRefresh(displayType = 'iframe') {\n    log.infof('starting refresh. displayType=%s', displayType);\n\n    // Save copy of current info before triggering changeState\n    const token = Object.assign({}, this.store.token)\n    const user = Object.assign({}, this.store.user)\n\n    // Also pass yet another isolated copy to changeState\n    this._changeState(authn.STATE_REFRESHING, Object.assign({}, this.store.user), Object.assign({}, this.store.token));\n\n    if (displayType !== 'iframe') {\n      this.startLogin(displayType);\n      return;\n    }\n\n    // If we have a refresh token, then try that before doing the more complicated iframe version\n    if (!(token && token.refresh)) {\n      this.startLogin('iframe');\n      return;\n    }\n\n    const tokenUrl = `${BASE_URL}/token`;\n    const body = new URLSearchParams();\n    body.set('grant_type', 'refresh_token');\n    body.set('client_id', this.config.clientId);\n    body.set('refresh_token', token.refresh)\n\n    const resp = await fetch(tokenUrl, {\n      method: 'POST',\n      headers: new Headers({ 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }),\n      body\n    });\n\n    if (resp.status !== 200) {\n      this.startLogin('iframe');\n      return;\n    }\n\n    const tokenInfo = await resp.json();\n    token.bearer = tokenInfo.access_token;\n    token.refresh = tokenInfo.refresh_token;\n    const expiresIn = tokenInfo.expires_in - EXPIRATION_BUFFER;\n    token.authorizationHeader = `Bearer ${token.bearer}`;\n    token.expiresAt = new Date(Date.now() + (expiresIn * 1000));\n\n    this._changeState(authn.STATE_AUTHENTICATED, user, token);\n  }\n\n  handleCurrentInfoRequest({callback}) {\n    log.debug('got current info request');\n    if (callback) {\n      callback(this.store);\n    }\n  }\n\n  _updateStateFromStorage() {\n    log.debug('updating state from local storage');\n    const serialized = this.storageHandler.getSessionState(this.config.clientId);\n    if (!serialized) {\n      log.debug('no stored state');\n      this._changeState(authn.STATE_UNAUTHENTICATED);\n      return;\n    }\n    const {user, token} = deserializeSessionState(serialized);\n    if (!user || !token) {\n      log.debug('no stored user or token');\n      this._changeState(authn.STATE_UNAUTHENTICATED);\n    } else if (token.expiresAt > new Date()) {\n      log.debug('found an unexpired saved session');\n      this._changeState(authn.STATE_AUTHENTICATED, user, token);\n    } else {\n      log.debug('stored session was expired');\n      this._changeState(authn.STATE_UNAUTHENTICATED);\n    }\n  }\n\n  _maybeUpdateStoredSession(state, user, token) {\n    log.debugf('updating stored session: state=%s hasUser=%s, hasToken=%s', state, !!user, !!token);\n    if (state === authn.STATE_UNAUTHENTICATED || state === authn.STATE_REFRESHING || state === authn.STATE_EXPIRED) {\n      log.debug('state is unauthenticated or expired, clearing stored session');\n      this.storageHandler.clearSessionState(this.config.clientId);\n    } else if (!!user && !!token) {\n      log.debug('storing session', redactUser(user), redactToken(token));\n      const serialized = serializeSessionState(user, token);\n      this.storageHandler.saveSessionState(this.config.clientId, serialized);\n    }\n  }\n}\n\nfunction serializeSessionState(user, token) {\n  const grouped = groupClaimPrefixes(token.rawUserInfo);\n\n  const smallerUserInfo = {\n    ro: grouped[CLAIMS_PREFIX_RESOURCE_OWNER],\n    cl: grouped[CLAIMS_PREFIX_CLIENT],\n    wso2: grouped[CLAIMS_PREFIX_WSO2],\n    o: grouped.other,\n  };\n\n  return {\n    ui: smallerUserInfo,\n    at: token.bearer,\n    rf: token.refresh,\n    ah: token.authorizationHeader,\n    ea: token.expiresAt.getTime()\n  };\n}\n\nfunction deserializeSessionState(state) {\n  const groupedUserInfo = {\n    [CLAIMS_PREFIX_RESOURCE_OWNER]: state.ui.ro,\n    [CLAIMS_PREFIX_CLIENT]: state.ui.cl,\n    [CLAIMS_PREFIX_WSO2]: state.ui.wso2,\n    other: state.ui.o,\n  }\n  const userInfo = ungroupClaimPrefixes(groupedUserInfo);\n\n  const user = _processUserInfo(userInfo);\n  const expiresAt = new Date(state.ea);\n  const token = _processTokenInfo({ userInfo, accessToken: state.at, expiresAt, authHeader: `Bearer ${state.at}`, refreshToken: state.rf });\n  return {user, token};\n}\n\nfunction _listenTo(provider, event, listener) {\n  if (provider._listeners.hasOwnProperty(event)) {\n    throw new Error('A listener is already registered for ' + event);\n  }\n  const obs = provider._listeners[event] = function (e) {\n    listener.call(provider, e.detail);\n  }.bind(provider);\n\n  provider.document.addEventListener(event, obs, false);\n}\n\nfunction _unlistenTo(provider, event) {\n  if (!provider._listeners.hasOwnProperty(event)) {\n    return;\n  }\n\n  provider.document.removeEventListener(event, provider._listeners[event], false);\n  delete provider._listeners[event];\n}\n\n\nfunction _dispatchEvent(provider, name, detail) {\n  let event;\n  if (typeof provider.window.CustomEvent === 'function') {\n    event = new CustomEvent(name, {detail});\n  } else {\n    event = provider.document.createEvent('CustomEvent');\n    event.initCustomEvent(name, true, false, detail);\n  }\n  provider.document.dispatchEvent(event);\n}\n\nasync function _handleAuthenticationCallback(config, location, storage) {\n  const searchParams = new URLSearchParams(location.search);\n\n  const oauthCsrfToken = searchParams.get('state');\n  const storedState = storage.getOAuthState(config.clientId);\n\n  storage.clearOAuthState(config.clientId);\n\n  log.debug('checking oauth state token');\n  const pageState = _validateAndGetStoredState(storedState, oauthCsrfToken);\n  const tokenInfo = await _fetchTokenInfo(searchParams.get('code'), config, storedState.v)\n\n  const accessToken = tokenInfo.access_token;\n  const refreshToken = tokenInfo.refresh_token;\n  const expiresIn = tokenInfo.expires_in - EXPIRATION_BUFFER;\n  const expiresAt = new Date(Date.now() + (expiresIn * 1000));\n  const authHeader = `Bearer ${accessToken}`;\n  log.debug('got token', redactBearerToken(accessToken), 'which expires in', expiresIn, 'seconds');\n\n  const userInfo = await _fetchUserInfo(authHeader);\n\n  const user = _processUserInfo(userInfo);\n  const token = _processTokenInfo({ userInfo, accessToken, expiresAt, authHeader, refreshToken });\n\n  return {state: authn.STATE_AUTHENTICATED, user, token};\n}\n\n\nasync function _fetchTokenInfo(code, config, codeVerifier) {\n  log.debug('Exchanging code for token');\n  const tokenUrl = `${BASE_URL}/token`;\n  const body = new URLSearchParams();\n  body.set('grant_type', 'authorization_code');\n  body.set('client_id', config.clientId);\n  body.set('redirect_uri', config.callbackUrl);\n  body.set('code', code);\n  body.set('code_verifier', codeVerifier)\n\n  const resp = await fetch(tokenUrl, {\n    method: 'POST',\n    headers: new Headers({ 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }),\n    body\n  });\n\n  if (resp.status !== 200) {\n    const body = await resp.text();\n\n    log.error('Error getting OAuth User Info. Status Code:', resp.status, 'Response:\\n', body);\n    throw new OAuthError(\n      'unable-to-exchange-code-for-token',\n      'Unable to exchange code for token. Please try again.'\n    );\n  }\n\n  const json = await resp.json();\n  log.debug('successfully got user info', json);\n  return json;\n}\n\nasync function _fetchUserInfo(authHeader) {\n  const USER_INFO_URL = `${BASE_URL}/openid-userinfo/v1/userinfo?schema=openid`;\n  log.debug('fetching user info from', USER_INFO_URL);\n  const resp = await fetch(USER_INFO_URL, {\n    method: 'GET',\n    headers: new Headers({'Accept': 'application/json', 'Authorization': authHeader}),\n    mode: 'cors',\n  });\n\n  log.debug('got status', resp.status);\n\n  if (resp.status !== 200) {\n    const body = await resp.text();\n\n    if (resp.status === 403) {\n      log.debug('got forbidden error');\n      if (body.includes('<ams:code>900908</ams:code>')) {\n        log.debug('client app isn\\'t subscribed to OpenID UserInfo endpoint');\n        log.error(`DEVELOPER ERROR: You may not be subscribed to the OpenID UserInfo endpoint. Please visit https://api.byu.edu/store/apis/info?name=OpenID-Userinfo&version=v1&provider=BYU%2Fjmooreoa to subscribe.`);\n        throw new OAuthError(\n          'not-subscribed-to-user-info',\n          'This page has an authentication configuration error. Developers, see the console for details.'\n        );\n      } else {\n        log.error('invalid oauth bearer token');\n        throw new OAuthError(\n          'invalid-oauth-token',\n          'The provided authentication token is invalid. Please try again.'\n        );\n      }\n    }\n    log.error('Error getting OAuth User Info. Status Code:', resp.status, 'Response:\\n', body);\n    throw new OAuthError(\n      'unable-to-get-user-info',\n      'Unable to fetch user information. Please try again.'\n    );\n  }\n  const json = await resp.json();\n  log.debug('successfully got user info', json);\n  return json;\n}\n\nconst CLAIMS_PREFIX_RESOURCE_OWNER = 'http://byu.edu/claims/resourceowner_';\nconst CLAIMS_PREFIX_CLIENT = 'http://byu.edu/claims/client_';\nconst CLAIMS_PREFIX_WSO2 = 'http://wso2.org/claims/';\n\nconst CLAIMS_KNOWN_PREFIXES = [CLAIMS_PREFIX_CLIENT, CLAIMS_PREFIX_RESOURCE_OWNER, CLAIMS_PREFIX_WSO2];\n\nfunction groupClaimPrefixes(userInfo) {\n  const grouped = {\n    other: {}\n  };\n  for (const prefix of CLAIMS_KNOWN_PREFIXES) {\n    grouped[prefix] = {};\n  }\n  for (const key of Object.keys(userInfo)) {\n    const value = userInfo[key];\n    const prefix = CLAIMS_KNOWN_PREFIXES.find(it => key.startsWith(it));\n    if (prefix) {\n        grouped[prefix][key.substr(prefix.length)] = value;\n    } else {\n      grouped.other[key] = value;\n    }\n  }\n  return grouped;\n}\n\nfunction ungroupClaimPrefixes(grouped) {\n  const result = {};\n  for (const groupKey of CLAIMS_KNOWN_PREFIXES) {\n    const group = grouped[groupKey];\n    if (!group) continue;\n    for (const key of Object.keys(group)) {\n      result[groupKey + key] = group[key];\n    }\n  }\n  for (const other of Object.keys(grouped.other)) {\n    result[other] = grouped.other[other];\n  }\n  return result;\n}\n\nfunction getClaims(userInfo, prefix) {\n  return Object.keys(userInfo).filter(k => k.startsWith(prefix))\n    .reduce((agg, key) => {\n      agg[key.substr(prefix.length)] = userInfo[key];\n      return agg;\n    }, {});\n}\n\nfunction _processUserInfo(userInfo) {\n  const roClaims = getClaims(userInfo, CLAIMS_PREFIX_RESOURCE_OWNER);\n\n  const familyNamePosition = roClaims.surname_position;\n  const givenName = roClaims.preferred_first_name;\n  const familyName = roClaims.surname;\n\n  const displayName = familyNamePosition === 'F' ? `${familyName} ${givenName}` : `${givenName} ${familyName}`;\n\n  return {\n    personId: roClaims.person_id,\n    byuId: roClaims.byu_id,\n    netId: roClaims.net_id,\n    name: {\n      sortName: roClaims.sort_name,\n      displayName,\n      givenName,\n      familyName,\n      familyNamePosition,\n    },\n    rawUserInfo: userInfo\n  };\n}\n\nfunction _processTokenInfo({ userInfo, accessToken, expiresAt, authHeader, refreshToken }) {\n  const clientClaims = getClaims(userInfo, CLAIMS_PREFIX_CLIENT);\n  const wso2Claims = getClaims(userInfo, CLAIMS_PREFIX_WSO2);\n\n  return {\n    bearer: accessToken,\n    refresh: refreshToken,\n    authorizationHeader: authHeader,\n    expiresAt,\n    client: {\n      id: wso2Claims.client_id,\n      byuId: clientClaims.byu_id,\n      appName: wso2Claims.applicationname,\n    },\n    rawUserInfo: userInfo\n  };\n}\n\nfunction _validateAndGetStoredState(storedState, expectedCsrfToken) {\n  log.debug('validating stored state token. Expecting token', expectedCsrfToken, ', got state', storedState);\n  if (!storedState) {\n    log.error('no stored oauth login state');\n    throw new OAuthError('no-oauth-state', 'Your saved authentication information does not match. Please try again.');\n  }\n  const {e: stateExpiresString, c: storedCsrfToken, s: pageState} = storedState;\n\n  if (expectedCsrfToken !== storedCsrfToken) {\n    log.error('CSRF token mismatch')\n    throw new OAuthError(\n      'oauth-state-mismatch',\n      'Your saved authentication information does not match. Please try again.'\n    );\n  }\n\n  if (Number(stateExpiresString) < Date.now()) {\n    log.error('stored state has expired');\n    throw new OAuthError(\n      'oauth-state-expired',\n      'Your login attempt has timed out. Please try again.'\n    );\n  }\n\n  return pageState;\n}\n\nfunction _prepareStoredState(expires, csrfToken, codeVerifier, pageState) {\n  return {\n    e: expires,\n    c: csrfToken,\n    v: codeVerifier,\n    s: pageState,\n  }\n}\n\nclass OAuthError extends Error {\n  constructor(type, description, uri) {\n    super('OAuth Error: ' + description);\n    this.type = type;\n    this.description = description;\n    this.uri = uri;\n  }\n}\n\nconst allowableRandomChars = [...'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'];\nconst randomCharRangeConvert = allowableRandomChars.length / 2**8; // Using Uint8Array for getRandomValues\n\nfunction randomString(length) {\n  const randomArray = new Uint8Array(length || 24);\n  const crypto = window.crypto || window.msCrypto;\n  crypto.getRandomValues(randomArray);\n\n  return randomArray.reduce((str, cur) => str + allowableRandomChars[Math.floor(cur * randomCharRangeConvert)], '');\n}\n\nfunction logStateChange(state, user, token, error) {\n  const logParts = [\n    'state change:',\n    {\n      state,\n      user: redactUser(user),\n      token: token, //redactToken(token),\n      error: error\n    }\n  ];\n  if (error) {\n    log.error(...logParts);\n  } else {\n    log.info(...logParts);\n  }\n}\n\nfunction redactUser(u) {\n  if (!u) return undefined;\n  return {\n    netId: u.netId,\n    'rest-is-redacted': true\n  };\n}\n\nfunction redactToken(t) {\n  log.debug('redacting token', t);\n  if (!t) return undefined;\n  const {bearer, expiresAt, client} = t;\n  return {\n    bearer: redactBearerToken(bearer),\n    expiresAt: !!expiresAt ? expiresAt.toISOString() : null,\n    client,\n    'rest-is-redacted': true\n  }\n}\nfunction redactBearerToken(b) {\n  if (!b) return undefined;\n  return b.substring(0, 2) + '...redacted...' + b.substring(b.length - 2)\n}\n\nfunction ensureOnlyInstance(obj) {\n  if (SINGLETON_INSTANCE) {\n    const trace = SINGLETON_INSTANCE.___startupTrace;\n    throw new Error('There is already an instance of byu-oauth-implicit running!  Please call `#shutdown()` on that instance before starting a new one. Instance was started at:\\n' + trace);\n  }\n  obj.___startupTrace = new Error().stack;\n  SINGLETON_INSTANCE = obj;\n}\n\nfunction cleanupOnlyInstance(obj) {\n  SINGLETON_INSTANCE = null;\n}\n\nexport function __forceShutdown() {\n  if (SINGLETON_INSTANCE) {\n    SINGLETON_INSTANCE.shutdown();\n    cleanupOnlyInstance(SINGLETON_INSTANCE);\n  }\n}\n","/*\n * Copyright 2018 Brigham Young University\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { IG_STATE_AUTO_REFRESH_FAILED, ImplicitGrantProvider } from \"./provider.js\";\nexport { IG_STATE_AUTO_REFRESH_FAILED }\n\nexport const DEFAULT_ISSUER = 'https://api.byu.edu';\nexport const DEFAULT_BASE_URL = 'https://api.byu.edu';\n\nexport const GLOBAL_CONFIG_KEY = 'byu-oauth-implicit-config';\n\n/**\n * @typedef {} ImplicitConfig\n * @prop {string} clientId\n * @prop {?string} issuer\n * @prop {?string} baseUrl\n * @prop {?string} callbackUrl\n * @prop {?boolean} requireAuthentication\n */\n\n/**\n * @param {ImplicitConfig|ImplicitConfig[]|undefined} cfgOrRules\n * @param location\n */\nexport async function configure(cfgOrRules, location = window.location) {\n  const cfg = resolveConfig(cfgOrRules, location);\n  const globalConfig = window[GLOBAL_CONFIG_KEY];\n\n  const config = Object.assign({\n    issuer: DEFAULT_ISSUER,\n    baseUrl: DEFAULT_BASE_URL,\n    callbackUrl: `${location.origin}${location.pathname}`,\n    autoRefreshOnTimeout: false\n  }, globalConfig, cfg);\n\n  if (!config.clientId) {\n    throw new Error('clientId must be specified in config');\n  }\n  const provider = new ImplicitGrantProvider(config, window, document);\n\n  return provider.startup();\n}\n\nfunction resolveConfig(rules, location) {\n  if (!rules) {\n    return {};\n  }\n\n  if ('clientId' in rules) {\n    return rules;\n  }\n\n  const keys = Object.keys(rules)\n    .filter(it => it.startsWith('https://') || it.startsWith('http://'));\n\n  if (keys.length === 0) {\n    return rules;\n  }\n\n  const key = keys\n    // order by length of key (most specific), descending\n    .sort((a, b) => b.length - a.length)\n    .find(it => location.href.startsWith(it));\n  if (key) {\n    return Object.assign({ callbackUrl: key }, rules[key]);\n  }\n  throw new Error(`Unable to match url [${location.href}] to one of [${keys}]`)\n}\n"],"names":["LEVEL_TRACE","priority","name","run","handleTrace","LEVEL_DEBUG","handleDebug","LEVEL_INFO","handleInfo","LEVEL_ERROR","handleError","ALL_LEVELS","DEFAULT_LEVEL","debug","args","log","info","error","debugf","format","logf","infof","level","shouldLog","getFormattedTime","now","Date","h24","String","getHours","padStart","min","getMinutes","sec","getSeconds","millis","getMilliseconds","formatTimezone","date","offset","getTimezoneOffset","nonNegative","absOffset","Math","abs","hourInt","floor","hourDone","sign","minDone","currentLevel","levelAttr","levelGlobalVar","lower","toLowerCase","find","l","document","documentElement","getAttribute","o","window","byuOAuth","logging","console","trace","EVENT_PREFIX","EVENT_STATE_CHANGE","EVENT_LOGIN_REQUESTED","EVENT_LOGOUT_REQUESTED","EVENT_REFRESH_REQUESTED","EVENT_CURRENT_INFO_REQUESTED","STATE_INDETERMINATE","STATE_UNAUTHENTICATED","STATE_AUTHENTICATED","STATE_AUTHENTICATING","STATE_REFRESHING","STATE_EXPIRED","STATE_ERROR","exports","parse","serialize","decode","decodeURIComponent","encode","encodeURIComponent","pairSplitRegExp","fieldContentRegExp","str","options","TypeError","obj","opt","pairs","split","dec","i","length","pair","eq_idx","indexOf","key","substr","trim","val","slice","undefined","tryDecode","enc","test","value","maxAge","isNaN","Error","domain","path","expires","toUTCString","httpOnly","secure","sameSite","e","Object","defineProperty","_createClass","defineProperties","target","props","descriptor","enumerable","configurable","writable","Constructor","protoProps","staticProps","prototype","hasCookies","_cookie2","_interopRequireDefault","_cookie","__esModule","default","_classCallCheck","instance","prefix","CookieStorage","arguments","cookieOptions","assign","getItem","cookies","cookie","hasOwnProperty","setItem","removeItem","clear","storage","TEST_KEY","isSupported","hasStorage","replace","_CookieStorage","MemoryStorage","_data","_isSupported2","_isSupported","_CookieStorage2","_MemoryStorage2","_MemoryStorage","localStorage","sessionStorage","StorageHandler","saveOAuthState","clientId","state","getKey","JSON","stringify","getOAuthState","result","clearOAuthState","saveSessionState","getSessionKey","getSessionState","stored","clearSessionState","sha256","sha256Lib","SINGLETON_INSTANCE","BASE_URL","CHILD_IFRAME_ID","STORED_STATE_LIFETIME","EXPIRATION_BUFFER","IG_STATE_AUTO_REFRESH_FAILED","ImplicitGrantProvider","constructor","config","storageHandler","_listeners","baseUrl","store","freeze","authn","user","token","_changeState","logStateChange","_dispatchEvent","_checkPopupOpener","origin","opener","location","URL","callbackUrl","_checkIframeOpener","iframe","parent","getElementById","contentWindow","handleStateChange","source","close","parentNode","removeChild","_maybeUpdateStoredSession","_checkExpired","expiresAt","getTime","startup","ensureOnlyInstance","listen","_location","isAuthenticationCallback","_handleAuthenticationCallback","err","hasStoredSession","_updateStateFromStorage","expirationTimeInMs","expiresInMs","__expirationTask","clearTimeout","setTimeout","autoRefreshOnTimeout","startRefresh","isCallbackUrl","href","hasCode","search","includes","shutdown","unlisten","cleanupOnlyInstance","_listenTo","startLogin","startLogout","handleCurrentInfoRequest","_unlistenTo","displayType","csrf","randomString","codeVerifier","codeChallenge","btoa","fromCharCode","array","storedState","_prepareStoredState","loginUrl","open","createElement","onload","html","body","innerHTML","id","src","style","appendChild","logoutRedirect","casLogoutUrl","logoutUrl","refresh","tokenUrl","URLSearchParams","set","resp","fetch","method","headers","Headers","status","tokenInfo","json","bearer","access_token","refresh_token","expiresIn","expires_in","authorizationHeader","callback","serialized","deserializeSessionState","redactUser","redactToken","serializeSessionState","grouped","groupClaimPrefixes","rawUserInfo","smallerUserInfo","ro","CLAIMS_PREFIX_RESOURCE_OWNER","cl","CLAIMS_PREFIX_CLIENT","wso2","CLAIMS_PREFIX_WSO2","other","ui","at","rf","ah","ea","groupedUserInfo","userInfo","ungroupClaimPrefixes","_processUserInfo","_processTokenInfo","accessToken","authHeader","refreshToken","provider","event","listener","obs","call","detail","bind","addEventListener","removeEventListener","CustomEvent","createEvent","initCustomEvent","dispatchEvent","searchParams","oauthCsrfToken","get","pageState","_validateAndGetStoredState","_fetchTokenInfo","v","redactBearerToken","_fetchUserInfo","code","text","OAuthError","USER_INFO_URL","mode","CLAIMS_KNOWN_PREFIXES","keys","it","startsWith","groupKey","group","getClaims","filter","k","reduce","agg","roClaims","familyNamePosition","surname_position","givenName","preferred_first_name","familyName","surname","displayName","personId","person_id","byuId","byu_id","netId","net_id","sortName","sort_name","clientClaims","wso2Claims","client","client_id","appName","applicationname","expectedCsrfToken","stateExpiresString","c","storedCsrfToken","s","Number","csrfToken","type","description","uri","allowableRandomChars","randomCharRangeConvert","randomArray","Uint8Array","crypto","msCrypto","getRandomValues","cur","logParts","u","t","toISOString","b","substring","___startupTrace","stack","DEFAULT_ISSUER","DEFAULT_BASE_URL","GLOBAL_CONFIG_KEY","configure","cfgOrRules","cfg","resolveConfig","globalConfig","issuer","pathname","rules","sort","a"],"mappings":"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"}