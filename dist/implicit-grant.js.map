{"version":3,"file":"implicit-grant.js","sources":["../node_modules/@byuweb/browser-oauth/constants.js","../src/implicit-grant.js"],"sourcesContent":["export const EVENT_PREFIX = 'byu-browser-oauth';\n\nexport const EVENT_STATE_CHANGE = `${EVENT_PREFIX}-state-changed`;\nexport const EVENT_LOGIN_REQUESTED = `${EVENT_PREFIX}-login-requested`;\nexport const EVENT_LOGOUT_REQUESTED = `${EVENT_PREFIX}-logout-requested`;\nexport const EVENT_REFRESH_REQUESTED = `${EVENT_PREFIX}-refresh-requested`;\nexport const EVENT_CURRENT_INFO_REQUESTED = `${EVENT_PREFIX}-current-info-requested`;\n\nexport const STATE_INDETERMINATE = 'indeterminate';\nexport const STATE_UNAUTHENTICATED = 'unauthenticated';\nexport const STATE_AUTHENTICATED = 'authenticated';\nexport const STATE_AUTHENTICATING = 'authenticating';\nexport const STATE_REFRESHING = 'refreshing';\nexport const STATE_EXPIRED = 'expired';\nexport const STATE_ERROR = 'error';\n\n","/*\n * Copyright 2018 Brigham Young University\n * \n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n * \n *    http://www.apache.org/licenses/LICENSE-2.0\n * \n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as authn from '../node_modules/@byuweb/browser-oauth/constants.js';\n\nexport const DEFAULT_ISSUER = 'https://api.byu.edu';\n\nlet config;\nconst observers = {};\nlet store = Object.freeze({ state: authn.STATE_INDETERMINATE });\n\n/*\n * TODOS:\n *  - implement logout\n *  - implement requireAuthentication\n */\n\n/**\n * @typedef {} ImplicitConfig\n * @prop {string} clientId\n * @prop {?string} issuer\n * @prop {?string} callbackUrl\n * @prop {?boolean} requireAuthentication\n */\n\n/**\n * \n * @param {ImplicitConfig} cfg \n */\nexport function configure(cfg) {\n    console.log('config', cfg);\n    if (!cfg) {\n        throw new Error('cfg must be defined');\n    }\n    if (!cfg.clientId) {\n        throw new Error('clientId must be specified');\n    }\n    config = Object.assign({\n        issuer: DEFAULT_ISSUER,\n        callbackUrl: `${location.origin}${location.pathname}`,\n        requireAuthentication: false,\n    }, cfg);\n\n    listen(authn.EVENT_LOGIN_REQUESTED, startLogin);\n    listen(authn.EVENT_LOGOUT_REQUESTED, startLogout);\n    listen(authn.EVENT_REFRESH_REQUESTED, startRefresh);\n    listen(authn.EVENT_CURRENT_INFO_REQUESTED, handleCurrentInfoRequest);\n\n    maybeHandleAuthenticationCallback();\n}\n\nfunction maybeHandleAuthenticationCallback() {\n    if (!isAuthenticationCallback()) {\n        console.log('Not an auth callback');\n        state(authn.STATE_UNAUTHENTICATED);\n        return;\n    }\n    state(authn.STATE_AUTHENTICATING);\n    const params = new URLSearchParams(window.location.hash.substring(1));\n    if (params.has('error')) {\n        const error = {\n            type: params.get('error'),\n            description: params.get('error_description'),\n            uri: params.get('error_uri')\n        };\n        state(\n            authn.STATE_ERROR,\n            null,\n            null,\n            error\n        );\n        return;\n    }\n\n    const csrf = params.get('state');\n\n    window.location.hash = '';\n\n    let pageData;\n    try {\n        pageData = validateCsrfAndGetPageData(csrf);\n    } catch (err) {\n        state(authn.STATE_ERROR, null, null, {\n            type: 'oauth-state-mismatch',\n            description: err.message || err,\n        });\n        return;\n    }\n\n    clearSavedStateFor('s');\n\n    const accessToken = params.get('access_token');\n    const expiresIn = Number(params.get('expires_in'));\n    const authHeader = `Bearer ${accessToken}`;\n    const expiresAt = new Date(Date.now() + (expiresIn * 1000));\n\n    fetch('https://api.byu.edu/openid-userinfo/v1/userinfo?schema=openid', {\n        method: 'GET',\n        headers: new Headers({ 'Accept': 'application/json', 'authorization': authHeader }),\n        mode: 'cors',\n    }).then(function (resp) {\n        return resp.json();\n    }).then(function (json) {\n        console.log('got user info', json);\n\n        const roClaims = getClaims(json, CLAIMS_PREFIX_RESOURCE_OWNER);\n        const clientClaims = getClaims(json, CLAIMS_PREFIX_CLIENT);\n        const wso2Claims = getClaims(json, CLAIMS_PREFIX_WSO2);\n\n        console.log('claims', roClaims, clientClaims, wso2Claims);\n\n        const familyNamePosition = roClaims.surname_position;\n        const givenName = json.given_name;\n        const familyName = json.family_name;\n\n        const displayName = familyNamePosition === 'F' ? `${familyName} ${givenName}` : `${givenName} ${familyName}`;\n\n        const user = {\n            personId: roClaims.person_id,\n            byuId: roClaims.byu_id,\n            netId: roClaims.net_id,\n            name: {\n                sortName: roClaims.sort_name,\n                displayName,\n                givenName,\n                familyName,\n                familyNamePosition,\n            },\n            rawUserInfo: json\n        };\n\n        const token = {\n            bearer: accessToken,\n            authorizationHeader: authHeader,\n            expiresAt,\n            client: {\n                id: wso2Claims.client_id,\n                byuId: clientClaims.byu_id,\n                appName: wso2Claims.applicationname,\n            },\n            rawUserInfo: json\n        };\n\n        state(authn.STATE_AUTHENTICATED, token, user);\n    });\n}\n\nconst CLAIMS_PREFIX_RESOURCE_OWNER = 'http://byu.edu/claims/resourceowner_';\nconst CLAIMS_PREFIX_CLIENT = 'http://byu.edu/claims/client_';\nconst CLAIMS_PREFIX_WSO2 = 'http://wso2.org/claims/';\n\nfunction getClaims(userInfo, prefix) {\n    return Object.keys(userInfo).filter(k => k.startsWith(prefix))\n        .reduce((agg, key) => {\n            agg[key.substr(prefix.length)] = userInfo[key];\n            return agg;\n        }, {});\n}\n\nfunction isAuthenticationCallback() {\n    const isCallbackUrl = window.location.href.indexOf(config.callbackUrl) === 0;\n    console.log(window.location.href, config.callbackUrl, window.location.href.indexOf(config.callbackUrl));\n    const hasHash = !!window.location.hash;\n\n    console.log('hasHash', hasHash);\n    if (!isCallbackUrl) {\n        return false;\n    } else if (!hasHash) {\n        return false;\n    }\n    const params = new URLSearchParams(window.location.hash.substring(1));\n    console.log('params', params);\n    if (params.has('access_token') || params.has('error')) {\n        console.log('has params');\n        return true;\n    }\n    return false;\n}\n\nfunction state(state, token, user, error) {\n    store = Object.freeze({ state, token, user, error });\n    dispatch(authn.EVENT_STATE_CHANGE, store);\n}\n\nexport function startLogin() {\n    console.log('startLogin', config);\n\n    const csrf = saveLoginToken(randomString(), {});\n\n    console.log('csrf', csrf);\n\n    const loginUrl = `https://api.byu.edu/authorize?response_type=token&client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.callbackUrl)}&scope=openid&state=${csrf}`;\n\n    console.log('loginUrl', loginUrl);\n    window.location = loginUrl;\n}\n\nexport function startLogout() {\n    console.log('startLogout');\n\n    window.location = 'http://api.byu.edu/logout?redirect_url=' + config.callbackUrl;\n    //https://api.byu.edu/revoke\n\n    //TODO: WSO2 Identity Server 5.1 allows us to revoke implicit tokens.  Once that's done, we'll need to do this.\n    // const url = `https://api.byu.edu/revoke`;\n\n    // const form = new URLSearchParams();\n    // form.set('token', store.token.bearer);\n    // form.set('client_id', config.clientId);\n    // form.set('token_type_hint', 'access_token');\n\n    // console.log('logout url', url);\n\n    // fetch(url, {\n    //     method: 'POST',\n    //     body: form,\n    //     // headers: {\n    //     //     'Content-Type': 'application/x-www-form-urlencoded'\n    //     // }\n    // }).then(result => {\n    //     console.log('done with logout', result);\n    // });\n}\n\nfunction saveLoginToken(token, pageState) {\n    const name = getStorageName(config.clientId);\n    const value = `${token}.${btoa(JSON.stringify(pageState))}`;\n\n    let type;\n    if (storageAvailable('sessionStorage')) {\n        window.sessionStorage.setItem(name, value);\n        type = TOKEN_STORE_TYPE_SESSION;\n    } else {\n        document.cookie = `${name}=${value};max-age=300`;\n        type = TOKEN_STORE_TYPE_COOKIE;\n    }\n    return type + '.' + token;\n}\n\nfunction getStorageName(clientId) {\n    return `oauth-state-${encodeURIComponent(clientId)}`;\n}\n\nconst TOKEN_STORE_TYPE_SESSION = 's';\nconst TOKEN_STORE_TYPE_COOKIE = 'c';\n\nfunction validateCsrfAndGetPageData(csrf) {\n    const [type, token] = csrf.split('.');\n    const possibleValues = getSavedStateFor(type);\n    \n    if (possibleValues.length === 0) {\n        console.error('No OAuth state has been stored, or it has expired');\n        throw new Error('Your authentication session has expired or something has gone wrong.');\n    } \n    const found = possibleValues.map(v => v.split('.'))\n        .find(([key, data]) => key === token);\n    \n    if (!found) {\n        console.error('Authentication state mismatch - no saved values match CSRF token');\n        throw new Error('Your saved authentication information does not match. Please try again.');\n    }\n\n    const pageData = found[1];\n\n    return JSON.parse(atob(pageData));\n}\n\nfunction getSavedStateFor(type) {\n    const name = getStorageName(config.clientId);\n    switch (type) {\n        case TOKEN_STORE_TYPE_SESSION:\n            return [window.sessionStorage.getItem(name)];\n        case TOKEN_STORE_TYPE_COOKIE:\n            const values = [];\n            (document.cookie || '').split(';').map(c => c.trim()).forEach(cookie => {\n                if (cookie.indexOf(name + '=') === 0) {\n                    values.push(cookie.split('=', 2)[1]);\n                }\n            });\n            return values;\n    }\n}\n\nfunction clearSavedStateFor(type) {\n    const name = getStorageName(config.clientId);\n    switch (type) {\n        case TOKEN_STORE_TYPE_SESSION:\n            window.sessionStorage.removeItem(name);\n            break;\n        case TOKEN_STORE_TYPE_COOKIE:\n            document.cookie = name + '=null;expires=Thu, 01 Jan 1970 00:00:00 GMT';\n            break;\n    }\n}\n\nexport function startRefresh() {\n    startLogin();\n}\n\nexport function handleCurrentInfoRequest({ callback }) {\n    callback(store);\n}\n\nfunction storageAvailable(type) {\n    try {\n        var storage = window[type],\n            x = '__storage_test__';\n        storage.setItem(x, x);\n        storage.removeItem(x);\n        return true;\n    }\n    catch (e) {\n        return e instanceof DOMException && (\n            // everything except Firefox\n            e.code === 22 ||\n            // Firefox\n            e.code === 1014 ||\n            // test name field too, because code might not be present\n            // everything except Firefox\n            e.name === 'QuotaExceededError' ||\n            // Firefox\n            e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&\n            // acknowledge QuotaExceededError only if there's something already stored\n            storage.length !== 0;\n    }\n}\n\nfunction randomString() {\n    let idArray = new Uint32Array(3);\n    const crypto = window.crypto || window.msCrypto;\n    crypto.getRandomValues(idArray);\n\n    return idArray.reduce((str, cur) => str + cur.toString(16), '');\n}\n\nfunction listen(event, listener) {\n    console.log('listening to', event);\n    if (observers.hasOwnProperty(event)) {\n        throw new Error('A listener is already registered for ' + event);\n    }\n    const obs = observers[event] = function (e) { listener(e.detail) };\n    document.addEventListener(event, obs, false);\n}\n\nfunction dispatch(name, detail) {\n    let event;\n    if (typeof window.CustomEvent === 'function') {\n        event = new CustomEvent(name, { detail });\n    } else {\n        event = document.createEvent('CustomEvent');\n        event.initCustomEvent(name, true, false, detail);\n    }\n    document.dispatchEvent(event);\n}\n"],"names":["authn.STATE_INDETERMINATE","authn.EVENT_LOGIN_REQUESTED","authn.EVENT_LOGOUT_REQUESTED","authn.EVENT_REFRESH_REQUESTED","authn.EVENT_CURRENT_INFO_REQUESTED","authn.STATE_UNAUTHENTICATED","authn.STATE_AUTHENTICATING","authn.STATE_ERROR","authn.STATE_AUTHENTICATED","authn.EVENT_STATE_CHANGE"],"mappings":"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"}